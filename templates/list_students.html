{% extends "base.html" %}


{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>
            {% if is_admin_view %}
                Listă Studenți (Total: {{ students_pagination.total if students_pagination else 0 }})
            {% elif students %}
                Listă Studenți Gestionați ({{ students|length }})
            {% else %}
                 Listă Studenți Gestionați (0)
            {% endif %}
        </h2>
        <div class="d-flex align-items-center">
            {# Butonul de adăugare student este vizibil pentru Gradat. Adminul poate adăuga prin altă interfață dacă e necesar, sau se poate adăuga aici #}
            {% if not is_admin_view %}
            <a href="{{ url_for('gradat_page_bulk_import_students') }}" class="btn btn-info btn-sm me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1 icon-rotate-hover" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Import Studenți (Pagină Nouă)
            </a>
            <a href="{{ url_for('add_student') }}" class="btn btn-success btn-sm me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-1 icon-rotate-hover" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0V8.5H10a.5.5 0 0 0 0-1H8.5v-1.5z"/>
                </svg>
                Adaugă Nou
            </a>
            {% endif %}
            {% if is_admin_view %}
                 <a href="{{ url_for('admin_dashboard_route') }}" class="btn btn-outline-secondary btn-sm">&laquo; Panou Admin</a>
            {% else %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">&laquo; Panou Gradat</a>
            {% endif %}
        </div>
    </div>
    <div class="alert alert-info" role="alert">
        Ghid scurt: căutați/filtrați studenții, faceți click pe nume pentru profil, sau selectați mai mulți și folosiți „Aplică Acțiune” pentru a adăuga permisii/învoiri/servicii în masă.
    </div>

    {% if is_admin_view %}
    <form method="GET" action="{{ url_for('list_students') }}" class="mb-3 bg-light p-3 rounded">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label for="search" class="form-label form-label-sm">Caută:</label>
                <input type="text" name="search" id="search" class="form-control form-control-sm" placeholder="Nume, prenume, ID unic..." value="{{ search_term or '' }}">
            </div>
            <div class="col-md-2">
                <label for="batalion" class="form-label form-label-sm">Batalion:</label>
                <select name="batalion" id="batalion" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for b in batalioane %}
                    <option value="{{ b }}" {% if b == filter_batalion %}selected{% endif %}>{{ b }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="companie" class="form-label form-label-sm">Companie:</label>
                <select name="companie" id="companie" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for c in companii %}
                    <option value="{{ c }}" {% if c == filter_companie %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="pluton" class="form-label form-label-sm">Pluton:</label>
                <select name="pluton" id="pluton" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for p in plutoane %}
                    <option value="{{ p }}" {% if p == filter_pluton %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary btn-sm">Filtrează</button>
                <a href="{{ url_for('list_students') }}" class="btn btn-outline-secondary btn-sm">Resetează</a>
            </div>
        </div>
    </form>
    {% elif not is_admin_view %} {# Search form for gradat #}
    <form method="GET" action="{{ url_for('list_students') }}" class="mb-3 bg-light p-3 rounded">
        <div class="row g-2 align-items-end">
            <div class="col-md-9">
                <label for="search" class="form-label form-label-sm">Caută în studenții gestionați:</label>
                <input type="text" name="search" id="search" class="form-control form-control-sm" placeholder="Nume, prenume, ID unic..." value="{{ search_term or '' }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-sm w-100">Caută</button>
                <a href="{{ url_for('list_students') }}" class="btn btn-outline-secondary btn-sm w-100 mt-1">Resetează Căutare</a>
            </div>
        </div>
    </form>
    {% endif %}

    {% set student_list = students_pagination.items if students_pagination else students %}

    <!-- Secțiune Acțiuni Multiple -->
    <div id="batch-actions-section" class="mb-3 p-3 border rounded bg-light" style="display: none;">
        <div class="d-flex align-items-center">
            <strong class="me-3">Cu <span id="selected-count">0</span> studenți selectați:</strong>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-play me-2"></i>Aplică Acțiune
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item batch-action-trigger" href="#" data-bs-toggle="modal" data-bs-target="#batchActionModal" data-action-type="permission">Adaugă Permisie</a></li>
                    <li><a class="dropdown-item batch-action-trigger" href="#" data-bs-toggle="modal" data-bs-target="#batchActionModal" data-action-type="daily_leave">Adaugă Învoire Zilnică</a></li>
                    <li><a class="dropdown-item batch-action-trigger" href="#" data-bs-toggle="modal" data-bs-target="#batchActionModal" data-action-type="service">Asignează Serviciu</a></li>
                </ul>
            </div>
        </div>
    </div>

    {% if student_list %}
    <div class="table-responsive shadow-sm">
        <table class="table table-striped table-hover table-sm">
            <thead class="table-light"> 
                <tr>
                    <th style="width: 30px;"><input type="checkbox" class="form-check-input" id="select-all-students"></th>
                    <th>Nr. Crt.</th>
                    <th>Grad</th>
                    <th>Nume și Prenume</th>
                    <th>ID Unic</th>
                    <th>Pluton</th>
                    <th>Companie</th>
                    <th>Batalion</th>
                    <th>Gen</th>
                    <th>Puncte Vol.</th>
                    <th>SMT</th>
                    <th>Alte Scutiri</th>
                    <th>Gradat Pl. Propriu</th>
                    <th>Gradat la Pl.</th>
                    {% if is_admin_view %}
                        <th>Creat De</th>
                    {% endif %}
                    <th>Acțiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for student in student_list %}
                <tr>
                    <td><input type="checkbox" class="form-check-input student-checkbox" name="student_ids" value="{{ student.id }}"></td>
                    <td>
                        {% if is_admin_view and students_pagination %}
                            {{ students_pagination.first + loop.index0 }}
                        {% else %}
                            {{ loop.index }}
                        {% endif %}
                    </td>
                    <td>{{ student.grad_militar }}</td>
                    <td>
                        <a href="{{ url_for('student_profile', student_id=student.id) }}" class="text-decoration-none">
                            {{ student.nume }} {{ student.prenume }}
                        </a>
                    </td>
                    <td>{{ student.id_unic_student if student.id_unic_student else '-' }}</td>
                    <td>{{ student.pluton }}</td>
                    <td>{{ student.companie }}</td>
                    <td>{{ student.batalion }}</td>
                    <td>{{ student.gender }}</td>
                    <td>{{ student.volunteer_points }}</td>
                    <td>
                        {% if student.is_smt %}
                            <span class="badge bg-secondary">SMT</span>
                        {% else %}
                            <span class="badge bg-secondary">Nu</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.exemption_details %}
                            <span class="badge bg-secondary" title="{{ student.exemption_details }}">{{ student.exemption_details[:20] }}{% if student.exemption_details|length > 20 %}...{% endif %}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if student.is_platoon_graded_duty %}
                            <span class="badge bg-secondary">Da</span>
                        {% else %}
                            <span class="badge bg-secondary">Nu</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ student.assigned_graded_platoon if student.assigned_graded_platoon else '-' }}
                    </td>
                    {% if is_admin_view %}
                    <td>
                        {% if student.creator %}
                            {{ student.creator.username }}
                            <small class="text-muted">({{ student.creator.role }})</small>
                        {% else %}
                            <small class="text-muted">N/A</small>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        <div class="btn-group">
                            <a href="{{ url_for('student_profile', student_id=student.id) }}" class="btn btn-primary btn-sm py-0 px-1" title="Vezi Profilul Complet">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if is_admin_view %}
                            <a href="{{ url_for('admin_edit_student', student_id=student.id) }}" class="btn btn-info btn-sm py-0 px-1" title="Editează (Admin)">
                                <i class="fas fa-user-shield"></i>
                            </a>
                            {% else %}
                            <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-warning btn-sm py-0 px-1" title="Editează">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Sigur doriți să ștergeți studentul {{ student.nume }} {{ student.prenume }} și toate datele asociate?');">
                                <button type="submit" class="btn btn-danger btn-sm py-0 px-1" title="Șterge">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if students_pagination and students_pagination.total > students_pagination.per_page %}
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center">
            {% set base_args = {'search': search_term or ''} %}
            {% if is_admin_view %}
                {% set _ = base_args.update({'batalion': filter_batalion or '', 'companie': filter_companie or '', 'pluton': filter_pluton or ''}) %}
            {% endif %}

            <li class="page-item {% if not students_pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('list_students', page=students_pagination.prev_num, **base_args) if students_pagination.has_prev else '#'}}">Precedenta</a>
            </li>

            {% for page_num in students_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                {% if page_num %}
                    <li class="page-item {% if students_pagination.page == page_num %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('list_students', page=page_num, **base_args) }}">{{ page_num }}</a>
                    </li>
                {% elif loop.index != 1 and loop.index != students_pagination.pages +1 %}
                     <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not students_pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('list_students', page=students_pagination.next_num, **base_args) if students_pagination.has_next else '#'}}">Următoarea</a>
            </li>
        </ul>
    </nav>
    <p class="text-center text-muted small">Afișare {{ students_pagination.items|length }} din {{ students_pagination.total }} studenți (Pagina {{ students_pagination.page }} din {{ students_pagination.pages }}).</p>
    {% elif students and not students_pagination %}
        <p class="text-center text-muted small">Total studenți: {{ student_list|length }}</p>
    {% endif %}

    {% elif is_admin_view %}
         <div class="alert alert-info">Nu s-au găsit studenți conform filtrelor aplicate sau nu există studenți în baza de date.</div>
    {% else %}
        <div class="alert alert-info" role="alert">
            Nu ai adăugat încă niciun student. <a href="{{ url_for('add_student') }}" class="alert-link">Adaugă primul student aici</a>.
        </div>
    {% endif %}

    {% if not is_admin_view %}
    <p class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
            &laquo; Înapoi la Panoul Gradat
        </a>
    </p>
    {% endif %}
</div>

<!-- Modal pentru Acțiuni Multiple -->
<div class="modal fade" id="batchActionModal" tabindex="-1" aria-labelledby="batchActionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="batchActionModalLabel">Aplică Acțiune în Masă</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="batch-action-form" method="POST" action="{{ url_for('batch_action_students') }}">
          <div class="modal-body">
                <input type="hidden" name="action_type" id="modal-action-type">
                <div id="selected-student-ids-container">
                    <!-- Hidden input-uri pentru ID-urile studenților vor fi adăugate aici de JS -->
                </div>

                <p>Se va aplica acțiunea pentru <strong id="modal-selected-count">0</strong> studenți.</p>
                <hr>

                <!-- Aici vor fi inserate dinamic câmpurile formularului -->
                <div id="modal-form-content">
                    <p class="text-muted">Vă rugăm selectați o acțiune.</p>
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
            <button type="submit" class="btn btn-primary">Aplică</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden Form Snippets for Batch Actions -->
<div id="batch-action-form-templates" style="display: none;">

    <!-- Snippet pentru Permisii (fără șabloane) -->
    <div id="form-snippet-permission">
        <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">Data și Ora de Început</label><input type="datetime-local" name="start_datetime" class="form-control" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">Data și Ora de Sfârșit</label><input type="datetime-local" name="end_datetime" class="form-control" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">Destinație</label><input type="text" name="destination" class="form-control"></div>
            <div class="col-md-6 mb-3"><label class="form-label">Mod Transport</label><input type="text" name="transport_mode" class="form-control"></div>
            <div class="col-12 mb-3"><label class="form-label">Motiv (Opțional)</label><input type="text" name="reason" class="form-control"></div>
        </div>
    </div>

    <!-- Snippet pentru Învoiri Zilnice (fără șabloane) -->
    <div id="form-snippet-daily_leave">
        <div class="row">
            <div class="col-md-4 mb-3"><label class="form-label">Data Învoirii</label><input type="date" name="leave_date" class="form-control" required></div>
            <div class="col-md-4 mb-3"><label class="form-label">Ora de Început</label><input type="time" name="start_time" class="form-control" required></div>
            <div class="col-md-4 mb-3"><label class="form-label">Ora de Sfârșit</label><input type="time" name="end_time" class="form-control" required></div>
        </div>
    </div>

    <!-- Snippet pentru Servicii (fără șabloane) -->
    <div id="form-snippet-service">
        <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">Tip Serviciu</label>
                <select name="service_type" class="form-select" required>
                    {% for st in service_types %}<option value="{{ st }}">{{ st }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3"><label class="form-label">Data Serviciului</label><input type="date" name="service_date" class="form-control" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">Ora de Început</label><input type="time" name="start_time" class="form-control" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">Ora de Sfârșit</label><input type="time" name="end_time" class="form-control" required></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all-students');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    const batchActionsSection = document.getElementById('batch-actions-section');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchActionModal = document.getElementById('batchActionModal');
    const modalSelectedCountSpan = batchActionModal.querySelector('#modal-selected-count');
    const selectedIdsContainer = batchActionModal.querySelector('#selected-student-ids-container');
    const modalFormContent = batchActionModal.querySelector('#modal-form-content');
    const modalActionTypeInput = batchActionModal.querySelector('#modal-action-type');
    const batchActionForm = batchActionModal.querySelector('#batch-action-form');

    function updateBatchActionUI() {
        const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
        const count = selectedCheckboxes.length;

        batchActionsSection.style.display = count > 0 ? 'block' : 'none';
        selectedCountSpan.textContent = count;
        selectAllCheckbox.checked = (count > 0 && count === studentCheckboxes.length);
        selectAllCheckbox.indeterminate = (count > 0 && count < studentCheckboxes.length);
    }

    selectAllCheckbox.addEventListener('change', function () {
        studentCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateBatchActionUI();
    });

    studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchActionUI);
    });

    batchActionModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const actionType = button.dataset.actionType;

        modalActionTypeInput.value = actionType;

        const selectedStudents = document.querySelectorAll('.student-checkbox:checked');
        modalSelectedCountSpan.textContent = selectedStudents.length;
        selectedIdsContainer.innerHTML = '';
        selectedStudents.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'student_ids[]';
            input.value = cb.value;
            selectedIdsContainer.appendChild(input);
        });

        const formSnippet = document.getElementById(`form-snippet-${actionType}`);
        if (formSnippet) {
            modalFormContent.innerHTML = formSnippet.innerHTML;
        } else {
            modalFormContent.innerHTML = '<p class="text-danger">Eroare: Nu s-a găsit formularul pentru această acțiune.</p>';
        }
    });

    updateBatchActionUI();
});
</script>
{% endblock %}
