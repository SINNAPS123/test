{% extends "base.html" %}

{% block title %}
    {% if is_admin_view %}Listă Studenți (Admin){% else %}Listă Studenți - {{ current_user.username }}{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>
            {% if is_admin_view %}
                Listă Studenți (Total: {{ students_pagination.total if students_pagination else 0 }})
            {% elif students %}
                Listă Studenți Gestionați ({{ students|length }})
            {% else %}
                 Listă Studenți Gestionați (0)
            {% endif %}
        </h2>
        <div>
            {# Butonul de adăugare student este vizibil pentru Gradat. Adminul poate adăuga prin altă interfață dacă e necesar, sau se poate adăuga aici #}
            {% if not is_admin_view %}
            <a href="{{ url_for('add_student') }}" class="btn btn-success me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                </svg>
                Adaugă Student Nou
            </a>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#bulkImportModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Import Studenți (Text)
            </button>
            {% endif %}
            {% if is_admin_view %}
                 <a href="{{ url_for('admin_dashboard_route') }}" class="btn btn-outline-secondary btn-sm">&laquo; Panou Admin</a>
            {% else %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">&laquo; Panou Gradat</a>
            {% endif %}
        </div>
    </div>

    {% if is_admin_view %}
    <form method="GET" action="{{ url_for('list_students') }}" class="mb-3 bg-light p-3 rounded">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label for="search" class="form-label form-label-sm">Caută:</label>
                <input type="text" name="search" id="search" class="form-control form-control-sm" placeholder="Nume, prenume, ID unic..." value="{{ search_term or '' }}">
            </div>
            <div class="col-md-2">
                <label for="batalion" class="form-label form-label-sm">Batalion:</label>
                <select name="batalion" id="batalion" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for b in batalioane %}
                    <option value="{{ b }}" {% if b == filter_batalion %}selected{% endif %}>{{ b }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="companie" class="form-label form-label-sm">Companie:</label>
                <select name="companie" id="companie" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for c in companii %}
                    <option value="{{ c }}" {% if c == filter_companie %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="pluton" class="form-label form-label-sm">Pluton:</label>
                <select name="pluton" id="pluton" class="form-select form-select-sm">
                    <option value="">Toate</option>
                    {% for p in plutoane %}
                    <option value="{{ p }}" {% if p == filter_pluton %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary btn-sm">Filtrează</button>
                <a href="{{ url_for('list_students') }}" class="btn btn-outline-secondary btn-sm">Resetează</a>
            </div>
        </div>
    </form>
    {% elif not is_admin_view %} {# Search form for gradat #}
    <form method="GET" action="{{ url_for('list_students') }}" class="mb-3 bg-light p-3 rounded">
        <div class="row g-2 align-items-end">
            <div class="col-md-9">
                <label for="search" class="form-label form-label-sm">Caută în studenții gestionați:</label>
                <input type="text" name="search" id="search" class="form-control form-control-sm" placeholder="Nume, prenume, ID unic..." value="{{ search_term or '' }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-sm w-100">Caută</button>
                <a href="{{ url_for('list_students') }}" class="btn btn-outline-secondary btn-sm w-100 mt-1">Resetează Căutare</a>
            </div>
        </div>
    </form>
    {% endif %}

    {% set student_list = students_pagination.items if students_pagination else students %}

    {% if student_list %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead class="table-light"> 
                <tr>
                    <th>Nr. Crt.</th>
                    <th>Grad</th>
                    <th>Nume</th>
                    <th>Prenume</th>
                    <th>ID Unic</th>
                    <th>Pluton</th>
                    <th>Companie</th>
                    <th>Batalion</th>
                    <th>Gen</th>
                    <th>Puncte Vol.</th>
                    {% if is_admin_view %}
                        <th>Creat De</th>
                        <th>Gradat Activ</th>
                        <th>Pl. Gradat</th>
                    {% endif %}
                    <th>Acțiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for student in student_list %}
                <tr>
                    <td>
                        {% if is_admin_view and students_pagination %}
                            {{ students_pagination.first + loop.index0 }}
                        {% else %}
                            {{ loop.index }}
                        {% endif %}
                    </td>
                    <td>{{ student.grad_militar }}</td>
                    <td>{{ student.nume }}</td>
                    <td>{{ student.prenume }}</td>
                    <td>{{ student.id_unic_student if student.id_unic_student else '-' }}</td>
                    <td>{{ student.pluton }}</td>
                    <td>{{ student.companie }}</td>
                    <td>{{ student.batalion }}</td>
                    <td>{{ student.gender }}</td>
                    <td>{{ student.volunteer_points }}</td>
                    {% if is_admin_view %}
                    <td>
                        {% if student.creator %}
                            {{ student.creator.username }}
                            <small class="text-muted">({{ student.creator.role }})</small>
                        {% else %}
                            <small class="text-muted">N/A</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.este_gradat_activ %}
                            <span class="badge bg-success">Da</span>
                        {% else %}
                            <span class="badge bg-secondary">Nu</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ student.pluton_gradat_la if student.pluton_gradat_la else '-' }}
                    </td>
                    {% endif %} {# end is_admin_view for extra columns #}
                    <td>
                        {% if is_admin_view %}
                        <a href="{{ url_for('admin_edit_student', student_id=student.id) }}" class="btn btn-info btn-sm py-0 px-1 me-1" title="Editare Student (Admin)">
                            <i class="fas fa-user-shield"></i> Edit
                        </a>
                        {% else %}
                        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-warning btn-sm py-0 px-1 me-1" title="Editare Student">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}
                        {# Butonul de ștergere student rămâne la fel, dar poate fi condiționat de rol dacă e necesar (deja este, ruta delete_student verifică rolul) #}
                        <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Sigur doriți să ștergeți studentul {{ student.nume }} {{ student.prenume }} și toate datele asociate?');">
                            <button type="submit" class="btn btn-danger btn-sm py-0 px-1" title="Ștergere Student">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        {# Funcționalitatea de toggle 'gradat de companie' a fost eliminată #}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Generalized Pagination for both Admin and Gradat #}
    {% if students_pagination and students_pagination.total > students_pagination.per_page %}
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center">
            {% set base_args = {'search': search_term or ''} %}
            {% if is_admin_view %}
                {% set _ = base_args.update({'batalion': filter_batalion or '', 'companie': filter_companie or '', 'pluton': filter_pluton or ''}) %}
            {% endif %}

            <li class="page-item {% if not students_pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('list_students', page=students_pagination.prev_num, **base_args) if students_pagination.has_prev else '#'}}">Precedenta</a>
            </li>

            {% for page_num in students_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                {% if page_num %}
                    <li class="page-item {% if students_pagination.page == page_num %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('list_students', page=page_num, **base_args) }}">{{ page_num }}</a>
                    </li>
                {% elif loop.index != 1 and loop.index != students_pagination.pages +1 %} {# Avoids multiple '...' for short lists #}
                     <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not students_pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('list_students', page=students_pagination.next_num, **base_args) if students_pagination.has_next else '#'}}">Următoarea</a>
            </li>
        </ul>
    </nav>
    <p class="text-center text-muted small">Afișare {{ students_pagination.items|length }} din {{ students_pagination.total }} studenți (Pagina {{ students_pagination.page }} din {{ students_pagination.pages }}).</p>
    {% elif students and not students_pagination %} {# Case where there are students but not enough for pagination (e.g. gradat with few students) #}
        <p class="text-center text-muted small">Total studenți: {{ student_list|length }}</p>
    {% endif %}

    {% elif is_admin_view %}
         <div class="alert alert-info">Nu s-au găsit studenți conform filtrelor aplicate sau nu există studenți în baza de date.</div>
    {% else %}
        <div class="alert alert-info" role="alert">
            Nu ai adăugat încă niciun student. <a href="{{ url_for('add_student') }}" class="alert-link">Adaugă primul student aici</a>.
        </div>
    {% endif %}

    {% if not is_admin_view %}
    <p class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
            &laquo; Înapoi la Panoul Gradat
        </a>
    </p>
    {% endif %}
</div>

<!-- Modal pentru Bulk Import -->
{% if not is_admin_view %}
<div class="modal fade" id="bulkImportModal" tabindex="-1" aria-labelledby="bulkImportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('gradat_bulk_import_students') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkImportModalLabel">Import Studenți în Masă</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Introduceți datele studenților, fiecare student pe un rând nou, în formatul:
                        <br><code>Grad Nume Prenume Gen Pluton Companie Batalion</code>
                        <br>Exemplu: <code>Sdt. Popescu Ion M 1 1 1</code>
                    </p>
                    <p>Gen: <strong>M</strong> (Masculin), <strong>F</strong> (Feminin), <strong>Nespecificat</strong>.</p>
                    <div class="mb-3">
                        <label for="student_bulk_data" class="form-label">Date Studenți:</label>
                        <textarea class="form-control" id="student_bulk_data" name="student_bulk_data" rows="10" required placeholder="M.m.IV Renț Francisc M 1 1 1&#10;Sdt. Ionescu Maria F 2 1 1"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <button type="submit" class="btn btn-primary">Importă Studenți</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
