{% extends "base.html" %}

{% block title %}Vizualizare Situație Salvată{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if is_public %}
    <div class="alert alert-info"><i class="fas fa-eye me-2"></i>Aceasta este o vizualizare publică, doar pentru citire.</div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0"><i class="fas fa-file-invoice me-2"></i> Vizualizare: {{ snapshot.name }}</h2>
            <p class="text-muted mb-0">Salvat la: {{ snapshot.created_at | localdatetime }}</p>
        </div>
        {% if not is_public %}
        <a href="{{ url_for('list_situation_snapshots') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Înapoi la Listă
        </a>
        {% endif %}
    </div>

    {% set student_map = {} %}
    {% for s in snapshot.data.students %}
        {% set _ = student_map.update({s.id_unic_student: s}) %}
    {% endfor %}

    <!-- Permissions -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Permisii ({{ snapshot.data.permissions|length }})</h5>
        </div>
        <div class="card-body">
            {% if snapshot.data.permissions %}
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Start</th>
                            <th>Sfârșit</th>
                            <th>Destinație</th>
                            <th>Transport</th>
                            <th>Motiv</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for p in snapshot.data.permissions %}
                        <tr>
                            <td>
                                {% set student_info = student_map.get(p.student_unique_id) %}
                                {{ student_info.grad_militar if student_info else '' }} {{ student_info.nume if student_info else 'N/A' }} {{ student_info.prenume if student_info else '' }}
                            </td>
                            <td>{{ p.start_datetime | localdatetime }}</td>
                            <td>{{ p.end_datetime | localdatetime }}</td>
                            <td>{{ p.destination }}</td>
                            <td>{{ p.transport_mode }}</td>
                            <td>{{ p.reason }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Nicio permisie în această situație.</p>
            {% endif %}
        </div>
    </div>

    <!-- Daily Leaves -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Învoiri Zilnice ({{ snapshot.data.daily_leaves|length }})</h5>
        </div>
        <div class="card-body">
            {% if snapshot.data.daily_leaves %}
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Data</th>
                            <th>Start</th>
                            <th>Sfârșit</th>
                            <th>Motiv</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for dl in snapshot.data.daily_leaves %}
                        <tr>
                            <td>
                                {% set student_info = student_map.get(dl.student_unique_id) %}
                                {{ student_info.grad_militar if student_info else '' }} {{ student_info.nume if student_info else 'N/A' }} {{ student_info.prenume if student_info else '' }}
                            </td>
                            <td>{{ dl.leave_date | localdate }}</td>
                            <td>{{ dl.start_time | localtime }}</td>
                            <td>{{ dl.end_time | localtime }}</td>
                            <td>{{ dl.reason }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Nicio învoire zilnică în această situație.</p>
            {% endif %}
        </div>
    </div>

    <!-- Weekend Leaves -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Învoiri Weekend ({{ snapshot.data.weekend_leaves|length }})</h5>
        </div>
        <div class="card-body">
            {% if snapshot.data.weekend_leaves %}
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Data Weekend (Vineri)</th>
                            <th>Detalii Zile</th>
                            <th>Biserică</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for wl in snapshot.data.weekend_leaves %}
                        <tr>
                            <td>
                                {% set student_info = student_map.get(wl.student_unique_id) %}
                                {{ student_info.grad_militar if student_info else '' }} {{ student_info.nume if student_info else 'N/A' }} {{ student_info.prenume if student_info else '' }}
                            </td>
                            <td>{{ wl.weekend_start_date | localdate }}</td>
                            <td>
                                {% set days = [] %}
                                {% if wl.day1_selected %}{% set _ = days.append(wl.day1_selected + ' (' + (wl.day1_start_time | localtime) + '-' + (wl.day1_end_time | localtime) + ')') %}{% endif %}
                                {% if wl.day2_selected %}{% set _ = days.append(wl.day2_selected + ' (' + (wl.day2_start_time | localtime) + '-' + (wl.day2_end_time | localtime) + ')') %}{% endif %}
                                {% if wl.day3_selected %}{% set _ = days.append(wl.day3_selected + ' (' + (wl.day3_start_time | localtime) + '-' + (wl.day3_end_time | localtime) + ')') %}{% endif %}
                                {{ days | join('; ') }}
                            </td>
                            <td>{{ 'Da' if wl.duminica_biserica else 'Nu' }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Nicio învoire de weekend în această situație.</p>
            {% endif %}
        </div>
    </div>

    <!-- Service Assignments -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Servicii ({{ snapshot.data.service_assignments|length }})</h5>
        </div>
        <div class="card-body">
            {% if snapshot.data.service_assignments %}
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Tip Serviciu</th>
                            <th>Start</th>
                            <th>Sfârșit</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for srv in snapshot.data.service_assignments %}
                        <tr>
                            <td>
                                {% set student_info = student_map.get(srv.student_unique_id) %}
                                {{ student_info.grad_militar if student_info else '' }} {{ student_info.nume if student_info else 'N/A' }} {{ student_info.prenume if student_info else '' }}
                            </td>
                            <td>{{ srv.service_type }}</td>
                            <td>{{ srv.start_datetime | localdatetime }}</td>
                            <td>{{ srv.end_datetime | localdatetime }}</td>
                            <td>{{ srv.notes }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Niciun serviciu în această situație.</p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}
