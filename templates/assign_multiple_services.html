{% extends "base.html" %}

{% block title %}Asignare Servicii în Masă{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Asignare Servicii în Masă</h2>
        <a href="{{ url_for('list_services') }}" class="btn btn-outline-secondary btn-sm">&laquo; Înapoi la Lista Servicii</a>
    </div>
    <div class="alert alert-info" role="alert">
        Ghid scurt: selectați studenții (Pasul 1), apoi completați detaliile (Pasul 2). Pentru fiecare tip, orele implicite se completează automat. „Participă Apel” este ON în mod implicit pentru toate serviciile, cu excepția Planton 1.
    </div>

    {% if not students_to_prepare %}
    <!-- ====================================================== -->
    <!-- PASUL 1: Selectarea Studenților                        -->
    <!-- ====================================================== -->
    <p class="text-muted">Selectați studenții pentru care doriți să adăugați servicii, apoi apăsați "Pregătește Asignarea".</p>
    <hr>
    <form method="GET" action="{{ url_for('assign_multiple_services') }}" id="studentSelectionForm">
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>1. Selectează Studenții</h5>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllStudents">
                    <label class="form-check-label" for="selectAllStudents">
                        Selectează/Deselectează Toți
                    </label>
                </div>
            </div>
            <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                {% if students %}
                    <div class="row">
                        {% for student in students %}
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="student_ids" value="{{ student.id }}" id="student_{{ student.id }}">
                                <label class="form-check-label" for="student_{{ student.id }}">
                                    {{ student.grad_militar }} {{ student.nume }} {{ student.prenume }} (Pl. {{ student.pluton }})
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nu aveți studenți în evidență.</p>
                {% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-lg">
                Pregătește Asignarea <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </form>

    {% else %}
    <!-- ====================================================== -->
    <!-- PASUL 2: Completarea Detaliilor                        -->
    <!-- ====================================================== -->
    <p class="text-muted">Completați detaliile pentru fiecare serviciu. Puteți folosi secțiunea "Date Comune" pentru a completa rapid toate câmpurile.</p>
    <hr>
    <form method="POST" action="{{ url_for('assign_multiple_services') }}" id="serviceDetailsForm">
        <!-- Secțiunea de Date Comune -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5>Date Comune (Opțional - pentru completare rapidă)</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label for="common_service_type" class="form-label">Tip Serviciu</label>
                        <select class="form-select" id="common_service_type">
                            <option value="" disabled selected>Alege...</option>
                            {% for type in service_types %}<option value="{{ type }}">{{ type }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="common_service_date" class="form-label">Data</label>
                        <input type="date" class="form-control" id="common_service_date" value="{{ today_str }}">
                    </div>
                    <div class="col-md-2">
                        <label for="common_start_time" class="form-label">Ora Început</label>
                        <input type="time" class="form-control" id="common_start_time">
                    </div>
                    <div class="col-md-2">
                        <label for="common_end_time" class="form-label">Ora Sfârșit</label>
                        <input type="time" class="form-control" id="common_end_time">
                    </div>
                    <div class="col-md-2">
                        <label for="common_notes" class="form-label">Observații</label>
                        <input type="text" class="form-control" id="common_notes">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-info w-100" id="fillAllButton">
                            <i class="fas fa-fill-drip"></i> Umple Tot
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelul cu Detalii -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5>2. Detalii Servicii pentru Studenții Selectați ({{ students_to_prepare|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Tip Serviciu <span class="text-danger">*</span></th>
                                <th>Data <span class="text-danger">*</span></th>
                                <th>Ora Început <span class="text-danger">*</span></th>
                                <th>Ora Sfârșit <span class="text-danger">*</span></th>
                                <th>Participă Apel</th>
                                <th>Observații</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students_to_prepare %}
                            <tr>
                                <input type="hidden" name="student_id_{{ student.id }}" value="{{ student.id }}">
                                <td>{{ student.grad_militar }} {{ student.nume }} {{ student.prenume }}</td>
                                <td>
                                    <select name="service_type_{{ student.id }}" class="form-select form-select-sm common-service-type" required>
                                        <option value="" disabled selected>Alege...</option>
                                        {% for type in service_types %}<option value="{{ type }}">{{ type }}</option>{% endfor %}
                                    </select>
                                </td>
                                <td><input type="date" name="service_date_{{ student.id }}" class="form-control form-control-sm common-service-date" value="{{ today_str }}" required></td>
                                <td><input type="time" name="start_time_{{ student.id }}" class="form-control form-control-sm common-start-time" required></td>
                                <td><input type="time" name="end_time_{{ student.id }}" class="form-control form-control-sm common-end-time" required></td>
                                <td class="text-center align-middle">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" name="participates_{{ student.id }}" checked>
                                    </div>
                                </td>
                                <td><input type="text" name="notes_{{ student.id }}" class="form-control form-control-sm common-notes"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <hr>
        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
            <a href="{{ url_for('assign_multiple_services') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Modifică Selecția
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-double"></i> Salvează Toate Serviciile
            </button>
        </div>
    </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logic for Step 1: Student Selection ---
    const studentSelectionForm = document.getElementById('studentSelectionForm');
    if (studentSelectionForm) {
        const selectAllCheckbox = document.getElementById('selectAllStudents');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const studentCheckboxes = document.querySelectorAll('input[name="student_ids"]');
                studentCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });
        }

        studentSelectionForm.addEventListener('submit', function(event) {
            const selectedStudents = document.querySelectorAll('input[name="student_ids"]:checked').length;
            if (selectedStudents === 0) {
                alert('Vă rugăm selectați cel puțin un student.');
                event.preventDefault();
            }
        });
    }

    // --- Logic for Step 2: Service Details ---
    const serviceDetailsForm = document.getElementById('serviceDetailsForm');
    if (serviceDetailsForm) {
        const defaultTimes = JSON.parse('{{ default_times_json|safe }}');
        const serviceNoRollCall = ["Planton 1"]; // Singurul tip care NU participă la apel

        // Autofill times when service type changes for a specific student
        serviceDetailsForm.querySelectorAll('.common-service-type').forEach(selectElement => {
            selectElement.addEventListener('change', function() {
                const selectedType = this.value;
                const row = this.closest('tr');
                if (defaultTimes[selectedType]) {
                    row.querySelector('.common-start-time').value = defaultTimes[selectedType][0];
                    row.querySelector('.common-end-time').value = defaultTimes[selectedType][1];
                }
                // Setează automat participarea la apel: doar Planton 1 NU participă
                const participatesSwitch = row.querySelector('input[type="checkbox"][name^="participates_"]');
                if (participatesSwitch) {
                    participatesSwitch.checked = !serviceNoRollCall.includes(selectedType);
                }
            });
        });

        // Autofill times when common service type changes
        const commonServiceType = document.getElementById('common_service_type');
        commonServiceType.addEventListener('change', function() {
             const selectedType = this.value;
             if (defaultTimes[selectedType]) {
                document.getElementById('common_start_time').value = defaultTimes[selectedType][0];
                document.getElementById('common_end_time').value = defaultTimes[selectedType][1];
            }
        });


        // "Fill All" button logic
        const fillAllButton = document.getElementById('fillAllButton');
        fillAllButton.addEventListener('click', function() {
            const commonType = commonServiceType.value;
            const commonDate = document.getElementById('common_service_date').value;
            const commonStart = document.getElementById('common_start_time').value;
            const commonEnd = document.getElementById('common_end_time').value;
            const commonNotes = document.getElementById('common_notes').value;

            document.querySelectorAll('tbody tr').forEach(row => {
                if(commonType) {
                    row.querySelector('.common-service-type').value = commonType;
                    // Ajustează automat participarea la apel în funcție de tip
                    const participatesSwitch = row.querySelector('input[type="checkbox"][name^="participates_"]');
                    if (participatesSwitch) {
                        participatesSwitch.checked = !serviceNoRollCall.includes(commonType);
                    }
                }
                if(commonDate) row.querySelector('.common-service-date').value = commonDate;
                if(commonStart) row.querySelector('.common-start-time').value = commonStart;
                if(commonEnd) row.querySelector('.common-end-time').value = commonEnd;
                row.querySelector('.common-notes').value = commonNotes;
            });
        });

        serviceDetailsForm.addEventListener('submit', function(event) {
            let isValid = true;
            const rows = serviceDetailsForm.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const serviceType = row.querySelector('.common-service-type').value;
                const serviceDate = row.querySelector('.common-service-date').value;
                const startTime = row.querySelector('.common-start-time').value;
                const endTime = row.querySelector('.common-end-time').value;

                if (!serviceType || !serviceDate || !startTime || !endTime) {
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('Verificați datele introduse. Fiecare serviciu trebuie să aibă tip, dată și ore completate.');
                event.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
