{% extends "base.html" %}

{% block title %}Listă Învoiri Zilnice - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Listă Învoiri Zilnice (Luni-Joi)</h2>
        <a href="{{ url_for('add_daily_leave') }}" class="btn btn-success">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar2-plus-fill" viewBox="0 0 16 16">
                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 3.5v1c0 .276.244.5.545.5h10.91c.3 0 .545-.224.545-.5v-1c0-.276-.244-.5-.546-.5H2.545c-.3 0-.545.224-.545.5zm6.5 5a.5.5 0 0 0-1 0V10H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V11h1.5a.5.5 0 0 0 0-1H9V8.5z"/>
            </svg>
            Adaugă Învoire Zilnică
        </a>
    </div>

    {% macro render_daily_leaves_table(leaves, table_title) %}
        {% if leaves %}
        <h4 class="mt-4">{{ table_title }} ({{ leaves|length }})</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Student</th>
                        <th>Data</th>
                        <th>De la</th>
                        <th>Până la</th>
                        <th>Tip</th>
                        <th>Motiv</th>
                        <th>Status</th>
                        <th>Acțiuni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leaves %}
                    <tr class="{{ 'table-success' if leave.is_active else ('table-warning' if leave.is_upcoming else 'table-secondary') }}">
                        <td>{{ leave.student.nume }} {{ leave.student.prenume }}</td>
                        <td>{{ leave.leave_date.strftime('%d-%m-%Y') }} ({{ leave.leave_date.strftime('%A') }})</td>
                        <td>{{ leave.start_time.strftime('%H:%M') }}</td>
                        <td>{{ leave.end_time.strftime('%H:%M') }} {% if leave.end_datetime.date() > leave.leave_date %}<span class="badge bg-info text-dark">ziua următoare</span>{% endif %}</td>
                        <td><span class="badge {% if leave.leave_type_display == 'În program' %}bg-primary{% elif leave.leave_type_display == 'Afară program' %}bg-secondary{% else %}bg-light text-dark{% endif %}">{{ leave.leave_type_display }}</span></td>
                        <td>{{ leave.reason if leave.reason else '-' }}</td>
                        <td>
                            {% if leave.status == 'Aprobată' %}
                                {% if leave.is_active %}
                                    <span class="badge bg-success">Activă</span>
                                {% elif leave.is_upcoming %}
                                    <span class="badge bg-warning text-dark">Urmează</span>
                                {% else %}
                                    <span class="badge bg-secondary">Expirată</span>
                                {% endif %}
                            {% elif leave.status == 'Anulată' %}
                                <span class="badge bg-danger">Anulată</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ leave.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if leave.status == 'Aprobată' and (leave.is_active or leave.is_upcoming) %}
                            <form method="POST" action="{{ url_for('cancel_daily_leave', leave_id=leave.id) }}" style="display: inline;" onsubmit="return confirm('Ești sigur că vrei să anulezi această învoire?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Anulează Învoirea">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                                    </svg>
                                    Anulează
                                </button>
                            </form>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted"><em>Nu există învoiri în această categorie.</em></p>
        {% endif %}
    {% endmacro %}

    {{ render_daily_leaves_table(active_leaves, 'Învoiri Active Acum') }}
    {{ render_daily_leaves_table(upcoming_leaves, 'Învoiri Viitoare') }}
    {{ render_daily_leaves_table(past_leaves, 'Învoiri Trecute/Anulate') }}

    <p class="mt-4">
        <a href="{{ url_for('gradat_dashboard') }}" class="btn btn-outline-secondary btn-sm">
            &laquo; Înapoi la Panoul Gradat
        </a>
    </p>
</div>
{% endblock %}
