{% extends "base.html" %}

{% block title %}{{ situation.title }}{% endblock %}

{% block content %}
<div class="mb-3">
  <h2 class="mb-1"><i class="fas fa-edit me-2"></i> {{ situation.title }}</h2>
  {% if situation.description %}
    <p class="text-muted">{{ situation.description }}</p>
  {% endif %}
</div>

{# Success notice for PRG: server should redirect with ?ok=1 after saving #}
{% if request.args.get('ok') %}
  <div class="alert alert-success">
    Formularul a fost trimis. Mulțumim!
  </div>
{% endif %}

<form method="POST" class="card p-3 shadow-sm" id="public-situation-form">
  <div class="alert alert-info py-2 small" role="alert">
    Câmpurile marcate cu <strong>*</strong> sunt obligatorii.
  </div>

  {% for f in fields %}
    {% set fname = f.name %}
    {% set flabel = f.label or f.name %}
    {% set ftype = f.type or 'text' %}
    {% set frequired = f.required %}
    {% set val = form_data.get(fname, f.get('default','')) %}
    {% set placeholder = f.get('placeholder') %}
    {% set help_text = f.get('help') %}

    <div class="mb-3">
      <label class="form-label">{{ flabel }}{% if frequired %} *{% endif %}</label>

      {# Long text #}
      {% if ftype == 'textarea' %}
        <textarea class="form-control" name="{{ fname }}" rows="4" placeholder="{{ placeholder or ('Introduceți ' ~ flabel|lower ~ '...') }}" {% if frequired %}required{% endif %}>{{ val }}</textarea>

      {# Date and Time #}
      {% elif ftype == 'date' %}
        <input type="date" class="form-control" name="{{ fname }}" value="{{ val }}" {% if frequired %}required{% endif %}>
      {% elif ftype == 'time' %}
        <input type="time" class="form-control" name="{{ fname }}" value="{{ val }}" {% if frequired %}required{% endif %}>

      {# Numeric, Email, Phone #}
      {% elif ftype == 'number' %}
        <input type="number" class="form-control" name="{{ fname }}" value="{{ val }}" placeholder="{{ placeholder or '' }}" {% if frequired %}required{% endif %}>
      {% elif ftype == 'email' %}
        <input type="email" class="form-control" name="{{ fname }}" value="{{ val }}" placeholder="{{ placeholder or 'ex: nume@exemplu.ro' }}" {% if frequired %}required{% endif %}>
      {% elif ftype == 'tel' %}
        <input type="tel" class="form-control" name="{{ fname }}" value="{{ val }}" placeholder="{{ placeholder or 'ex: 07xx xxx xxx' }}" {% if frequired %}required{% endif %}>

      {# Select with options #}
      {% elif ftype == 'select' and f.options %}
        <select class="form-select" name="{{ fname }}" {% if frequired %}required{% endif %}>
          <option value="">{% if placeholder %}{{ placeholder }}{% else %}-- selectează --{% endif %}</option>
          {% for opt in f.options %}
            <option value="{{ opt }}" {% if val == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>

      {# Radio group (single choice) #}
      {% elif ftype == 'radio' and f.options %}
        <div class="d-flex flex-wrap gap-3">
          {% for opt in f.options %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="{{ fname }}" id="{{ fname }}_{{ loop.index }}" value="{{ opt }}" {% if val == opt %}checked{% endif %} {% if frequired %}required{% endif %}>
              <label class="form-check-label" for="{{ fname }}_{{ loop.index }}">{{ opt }}</label>
            </div>
          {% endfor %}
        </div>

      {# Checkbox (boolean) #}
      {% elif ftype == 'checkbox' %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="{{ fname }}" id="{{ fname }}" value="1" {% if val in ['1','true','True','on','yes'] or f.get('default') in ['1','true','True','on','yes'] %}checked{% endif %}>
          <label class="form-check-label" for="{{ fname }}">{{ placeholder or 'Bifează dacă este cazul' }}</label>
        </div>

      {# Student selector (scoped to creator's students) #}
      {% elif ftype == 'student_select' and students_options %}
        <select class="form-select" name="{{ fname }}" {% if frequired %}required{% endif %}>
          <option value="">{% if placeholder %}{{ placeholder }}{% else %}-- selectează student --{% endif %}</option>
          {% for opt in students_options %}
            <option value="{{ opt.value }}" {% if val == opt.value %}selected{% endif %}>{{ opt.label }}</option>
          {% endfor %}
        </select>

      {# Default text input #}
      {% else %}
        <input type="text" class="form-control" name="{{ fname }}" value="{{ val }}" placeholder="{{ placeholder or ('Introduceți ' ~ flabel|lower ~ '...') }}" {% if frequired %}required{% endif %}>
      {% endif %}

      {% if help_text %}
        <div class="form-text">{{ help_text }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary" id="submit-btn">
      <i class="fas fa-paper-plane me-2"></i> Trimite
    </button>
    <a href="{{ url_for('public_view_login') }}" class="btn btn-outline-secondary">Înapoi</a>
  </div>

  <p class="text-muted small mt-3 mb-0">
    Datele sunt folosite doar pentru această raportare și sunt stocate securizat.
  </p>
</form>

<script>
  (function() {
    try {
      const form = document.getElementById('public-situation-form');
      const btn = document.getElementById('submit-btn');
      // Build a localStorage key unique per situation (uses public_code when available)
      const key = 'sit_submit_' + ({{ situation.public_code and ('\"' ~ situation.public_code ~ '\"') or '\"' ~ situation.id ~ '\"' }});
      // Prevent multiple rapid submissions
      let submitting = false;
      if (form && btn) {
        form.addEventListener('submit', function(e) {
          if (submitting) {
            e.preventDefault();
            return false;
          }
          submitting = true;
          // Disable button to prevent double-clicks
          btn.disabled = true;
          btn.classList.add('disabled');
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Trimitere...';

          // Mark submit time (10 minutes window)
          try {
            const now = Date.now();
            localStorage.setItem(key, String(now));
          } catch (_) {}
        });
      }

      // Optional: if user refreshes immediately after submit, avoid accidental re-submission via browser UI
      try {
        const last = parseInt(localStorage.getItem(key) || '0', 10);
        const tenMinutes = 10 * 60 * 1000;
        if (last && (Date.now() - last) < tenMinutes) {
          // Show a gentle info message and keep form enabled (server uses PRG ideally)
          const info = document.createElement('div');
          info.className = 'alert alert-info mt-3';
          info.innerText = 'Am primit o trimitere recentă. Dacă ați apăsat din greșeală refresh, nu este nevoie să retrimiteți.';
          form.parentNode.insertBefore(info, form);
        }
      } catch (_) {}
    } catch (_) {}
  })();
</script>
{% endblock %}