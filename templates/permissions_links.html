{% extends "base.html" %}

{% block title %}Link-uri Publice Clasament Permisii{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fas fa-link me-2"></i>
        Gestionare Link-uri Publice - Clasament Permisii
    </h2>

    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Aici puteți genera, vizualiza și revoca link-uri publice pentru clasamentul de permisii. Oricine are un link activ poate vizualiza clasamentul.
    </div>

    <!-- Link Generation Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong><i class="fas fa-plus-circle me-2"></i>Generează un Link Nou</strong>
        </div>
        <div class="card-body">
            <form id="generate-link-form">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label for="expiry_days" class="form-label">Valabilitate (zile)</label>
                        <input type="number" class="form-control" id="expiry_days" value="90" min="1" max="36500">
                    </div>
                    <div class="col-md-4 d-flex align-items-center pt-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permanent_link">
                            <label class="form-check-label" for="permanent_link">Link Permanent (nu expiră)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-cogs me-2"></i>Generează
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Active Links Card -->
    <div class="card shadow-sm">
        <div class="card-header">
            <strong><i class="fas fa-list-ul me-2"></i>Link-uri Active</strong>
        </div>
        <div class="card-body">
            <div id="active-links-container" class="list-group">
                <!-- Links will be loaded here by JavaScript -->
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Slug Management Modal -->
<div class="modal fade" id="slugModal" tabindex="-1" aria-labelledby="slugModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="slugModalLabel">Setează Alias (URL Scurt)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Puteți seta un alias personalizat pentru link-ul public. Acesta trebuie să fie unic.</p>
        <p><strong>URL-ul final va fi:</strong> <span id="slug-preview-base"></span><strong id="slug-preview-text"></strong></p>
        <input type="hidden" id="slug-code-input">
        <div class="mb-3">
          <label for="slug-input" class="form-label">Alias dorit (ex: clasament-permisii-2024)</label>
          <input type="text" class="form-control" id="slug-input" placeholder="litere, cifre, liniuță (-)">
          <div class="form-text">Folosiți doar litere mici, cifre și cratimă. Fără spații sau alte caractere speciale.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
        <button type="button" class="btn btn-danger" id="remove-slug-btn">Șterge Alias</button>
        <button type="button" class="btn btn-primary" id="save-slug-btn">Salvează Alias</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiBaseUrl = "{{ url_for('permissions_links_manage') }}"; // A bit of a hack, but gets the base path
    const generateForm = document.getElementById('generate-link-form');
    const linksContainer = document.getElementById('active-links-container');
    const slugModal = new bootstrap.Modal(document.getElementById('slugModal'));
    const slugInput = document.getElementById('slug-input');
    const slugCodeInput = document.getElementById('slug-code-input');
    const saveSlugBtn = document.getElementById('save-slug-btn');
    const removeSlugBtn = document.getElementById('remove-slug-btn');
    const slugPreviewBase = document.getElementById('slug-preview-base');
    const slugPreviewText = document.getElementById('slug-preview-text');

    slugPreviewBase.textContent = "{{ url_for('home', _external=True) }}p/";

    async function fetchLinks() {
        linksContainer.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
        try {
            const response = await fetch("{{ url_for('permissions_list_public_links') }}");
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            renderLinks(data.codes || []);
        } catch (error) {
            console.error('Error fetching links:', error);
            linksContainer.innerHTML = `<div class="alert alert-danger">Nu s-au putut încărca link-urile.</div>`;
        }
    }

    function renderLinks(codes) {
        if (codes.length === 0) {
            linksContainer.innerHTML = `<div class="list-group-item">Nu există link-uri active.</div>`;
            return;
        }
        linksContainer.innerHTML = codes.map(code => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong class="d-block">${code.public_url}</strong>
                    <small class="text-muted">Expiră: ${code.never_expires ? 'Niciodată' : new Date(code.expires_at).toLocaleString()}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="copyToClipboard('${code.public_url}')" title="Copiază Link"><i class="fas fa-copy"></i></button>
                    <button class="btn btn-sm btn-outline-info me-2" onclick="manageSlug('${code.code}')" title="Setează Alias"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="revokeLink('${code.code}')" title="Revocă Link"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    generateForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const permanent = document.getElementById('permanent_link').checked;
        const days = document.getElementById('expiry_days').value;

        try {
            const response = await fetch("{{ url_for('permissions_generate_public_link') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': '{{ csrf_token() }}' },
                body: JSON.stringify({ permanent, days: parseInt(days, 10) })
            });
            if (!response.ok) throw new Error('Failed to generate link');
            fetchLinks(); // Refresh list
        } catch (error) {
            console.error('Error generating link:', error);
            alert('A apărut o eroare la generarea link-ului.');
        }
    });

    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Link copiat în clipboard!');
        }, () => {
            alert('Eroare la copierea link-ului.');
        });
    }

    window.revokeLink = async function(code) {
        if (!confirm('Sunteți sigur că doriți să revocați acest link? Acțiunea este ireversibilă.')) return;
        try {
            const response = await fetch("{{ url_for('permissions_revoke_public_link') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': '{{ csrf_token() }}' },
                body: JSON.stringify({ code })
            });
            if (!response.ok) throw new Error('Failed to revoke link');
            fetchLinks();
        } catch (error) {
            console.error('Error revoking link:', error);
            alert('A apărut o eroare la revocarea link-ului.');
        }
    }

    window.manageSlug = async function(code) {
        slugCodeInput.value = code;
        slugInput.value = '';
        slugPreviewText.textContent = '';
        try {
            const response = await fetch(`{{ url_for('permissions_get_public_slug') }}?code=${code}`);
            if(response.ok) {
                const data = await response.json();
                if(data.custom_slug) {
                    slugInput.value = data.custom_slug;
                    slugPreviewText.textContent = data.custom_slug;
                }
            }
            slugModal.show();
        } catch (error) {
            alert('Nu s-a putut încărca alias-ul curent.');
        }
    }

    slugInput.addEventListener('input', function() {
        slugPreviewText.textContent = this.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
    });

    saveSlugBtn.addEventListener('click', async function() {
        const code = slugCodeInput.value;
        const slug = slugInput.value.trim();
        try {
            const response = await fetch("{{ url_for('permissions_set_public_slug') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': '{{ csrf_token() }}' },
                body: JSON.stringify({ code, slug })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to set alias');
            slugModal.hide();
            fetchLinks();
        } catch (error) {
            alert(`Eroare: ${error.message}`);
        }
    });

    removeSlugBtn.addEventListener('click', async function() {
        if (!confirm('Sunteți sigur că doriți să ștergeți acest alias?')) return;
        slugInput.value = ''; // Set to empty to trigger removal
        saveSlugBtn.click();
    });

    // Initial fetch
    fetchLinks();
});
</script>
{% endblock %}