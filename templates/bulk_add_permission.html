{% extends "base.html" %}

{% block title %}Adăugare Permisii în Masă{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Adăugare Permisii în Masă</h2>
        <a href="{{ url_for('list_permissions') }}" class="btn btn-outline-secondary btn-sm">&laquo; Înapoi la Lista Permisii</a>
    </div>

    {% if not students_to_prepare %}
    <!-- ====================================================== -->
    <!-- PASUL 1: Selectarea Studenților                        -->
    <!-- ====================================================== -->
    <p class="text-muted">Selectați studenții pentru care doriți să adăugați permisii, apoi apăsați "Pregătește Permisii".</p>
    <hr>
    <form method="GET" action="{{ url_for('gradat_bulk_add_permission') }}" id="studentSelectionForm">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between w-100">
                    <h5 class="mb-0">1. Selectează Studenții</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="position-relative">
                            <input type="text" id="studentSearchInput" class="form-control form-control-sm" placeholder="Caută student (min. 2 caractere)">
                            <div id="studentSuggestions" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 250px; overflow-y: auto; display:none;"></div>
                        </div>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="selectAllStudents">
                            <label class="form-check-label" for="selectAllStudents">
                                Selectează/Deselectează Toți
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-muted small">Sugestii de căutare apar sub câmp pe măsură ce tastați. Selectarea unei sugestii bifează studentul în listă.</div>
            </div>
            <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                {% if students %}
                    <div class="row" id="studentsList">
                        {% for student in students %}
                        <div class="col-md-4 student-item" data-name="{{ (student.grad_militar ~ ' ' ~ student.nume ~ ' ' ~ student.prenume ~ ' Pl.' ~ student.pluton)|lower }}">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="student_ids" value="{{ student.id }}" id="student_{{ student.id }}">
                                <label class="form-check-label" for="student_{{ student.id }}">
                                    {{ student.grad_militar }} {{ student.nume }} {{ student.prenume }} (Pl. {{ student.pluton }})
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nu aveți studenți în evidență.</p>
                {% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-lg">
                Pregătește Permisii <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </form>

    {% else %}
    <!-- ====================================================== -->
    <!-- PASUL 2: Completarea Detaliilor                        -->
    <!-- ====================================================== -->
    <p class="text-muted">Completați detaliile pentru fiecare permisie. Puteți folosi secțiunea "Date Comune" pentru a completa rapid toate câmpurile.</p>
    <hr>
    <form method="POST" action="{{ url_for('gradat_bulk_add_permission') }}" id="permissionDetailsForm">
        <!-- Secțiunea de Date Comune -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5>Date Comune (Opțional - pentru completare rapidă)</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end g-2">
                    <div class="col-md-3">
                        <label for="common_start_datetime" class="form-label">Început</label>
                        <input type="datetime-local" class="form-control" id="common_start_datetime">
                    </div>
                    <div class="col-md-3">
                        <label for="common_end_datetime" class="form-label">Sfârșit</label>
                        <input type="datetime-local" class="form-control" id="common_end_datetime">
                        <div class="input-group input-group-sm mt-2">
                            <span class="input-group-text">Durată (ore)</span>
                            <input type="number" class="form-control" id="common_duration_hours" step="0.5" min="0" placeholder="ex: 12">
                        </div>
                        <small class="form-text text-muted">Optional: dacă specificați durata și lăsați câmpul „Sfârșit” gol, se va calcula automat din „Început”.</small>
                    </div>
                    <div class="col-md-2">
                        <label for="common_destination" class="form-label">Destinația</label>
                        <input type="text" class="form-control" id="common_destination" placeholder="Ex: Acasă">
                    </div>
                    <div class="col-md-2">
                        <label for="common_transport_mode" class="form-label">Transport</label>
                        <input type="text" class="form-control" id="common_transport_mode" placeholder="Ex: Personal">
                    </div>
                    <div class="col-md-2">
                        <label for="common_pluton" class="form-label">Grupa/Pluton</label>
                        <input type="text" class="form-control" id="common_pluton" placeholder="ex: 32 sau 'ALL 32'">
                    </div>
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-info" id="fillAllButton">
                        <i class="fas fa-fill-drip"></i> Umple Tot
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabelul cu Detalii -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5>2. Detalii Permisii pentru Studenții Selectați ({{ students_to_prepare|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Început <span class="text-danger">*</span></th>
                                <th>Sfârșit <span class="text-danger">*</span></th>
                                <th>Destinația</th>
                                <th>Transport</th>
                                <th>Grupa</th>
                                <th>Motiv/Observații</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students_to_prepare %}
                            <tr>
                                <input type="hidden" name="student_id_{{ student.id }}" value="{{ student.id }}">
                                <td>{{ student.grad_militar }} {{ student.nume }} {{ student.prenume }}</td>
                                <td><input type="datetime-local" name="start_datetime_{{ student.id }}" class="form-control form-control-sm common-start" required></td>
                                <td><input type="datetime-local" name="end_datetime_{{ student.id }}" class="form-control form-control-sm common-end" required></td>
                                <td><input type="text" name="destination_{{ student.id }}" class="form-control form-control-sm common-dest"></td>
                                <td><input type="text" name="transport_mode_{{ student.id }}" class="form-control form-control-sm common-transport"></td>
                                <td><input type="text" name="pluton_{{ student.id }}" class="form-control form-control-sm common-pluton" value="{{ student.pluton }}"></td>
                                <td><input type="text" name="reason_{{ student.id }}" class="form-control form-control-sm"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <hr>
        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
            <a href="{{ url_for('gradat_bulk_add_permission') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Modifică Selecția Studenților
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-double"></i> Salvează Toate Permisiile
            </button>
        </div>
    </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logic for Step 1: Student Selection ---
    const studentSelectionForm = document.getElementById('studentSelectionForm');
    if (studentSelectionForm) {
        const selectAllCheckbox = document.getElementById('selectAllStudents');
        const searchInput = document.getElementById('studentSearchInput');
        const suggestionsEl = document.getElementById('studentSuggestions');
        const listEl = document.getElementById('studentsList');

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const studentCheckboxes = document.querySelectorAll('input[name="student_ids"]');
                studentCheckboxes.forEach(cb => { cb.checked = this.checked; });
            });
        }

        // Client-side filtering of visible list (name contains typed value)
        function filterVisibleList(query) {
            const q = (query || '').trim().toLowerCase();
            document.querySelectorAll('.student-item').forEach(item => {
                const name = (item.getAttribute('data-name') || '').toLowerCase();
                item.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
        }

        // Debounced API search for suggestions
        let debounceTimer = null;
        async function fetchSuggestions(q) {
            if (!q || q.length < 2) {
                suggestionsEl.style.display = 'none';
                suggestionsEl.innerHTML = '';
                return;
            }
            try {
                const url = `/api/v1/students/search?q=${encodeURIComponent(q)}`;
                const res = await fetch(url, { headers: { 'X-CSRFToken': window.CSRF_TOKEN || '' } });
                const data = await res.json();
                const items = (data && data.data && data.data.students) ? data.data.students : [];
                if (!items.length) {
                    suggestionsEl.style.display = 'none';
                    suggestionsEl.innerHTML = '';
                    return;
                }
                suggestionsEl.innerHTML = items.map(s => `
                    <button type="button" class="list-group-item list-group-item-action" data-student-id="${s.id}">
                        ${s.name} (Pl. ${s.platoon || '-'})
                    </button>
                `).join('');
                suggestionsEl.style.display = 'block';
            } catch (e) {
                suggestionsEl.style.display = 'none';
                suggestionsEl.innerHTML = '';
            }
        }

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const val = e.target.value || '';
                filterVisibleList(val);
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchSuggestions(val), 250);
            });
            document.addEventListener('click', (e) => {
                if (!suggestionsEl.contains(e.target) && e.target !== searchInput) {
                    suggestionsEl.style.display = 'none';
                }
            });
        }

        if (suggestionsEl) {
            suggestionsEl.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-student-id]');
                if (!btn) return;
                const sid = btn.getAttribute('data-student-id');
                const cb = document.getElementById(`student_${sid}`);
                if (cb) {
                    cb.checked = true;
                    // Optionally scroll into view and highlight
                    const card = cb.closest('.student-item');
                    if (card) {
                        card.style.outline = '2px solid var(--bs-primary)';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => { card.style.outline = ''; }, 1200);
                    }
                }
                suggestionsEl.style.display = 'none';
                suggestionsEl.innerHTML = '';
            });
        }

        studentSelectionForm.addEventListener('submit', function(event) {
            const selectedStudents = document.querySelectorAll('input[name="student_ids"]:checked').length;
            if (selectedStudents === 0) {
                alert('Vă rugăm selectați cel puțin un student.');
                event.preventDefault();
            }
        });
    }

    // --- Logic for Step 2: Permission Details ---
    const permissionDetailsForm = document.getElementById('permissionDetailsForm');
    if (permissionDetailsForm) {
        const fillAllButton = document.getElementById('fillAllButton');

        // Prefill per-student fields from last permission (destination, transport, reason)
        (function prefillFromLast(){
            const rows = permissionDetailsForm.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const hiddenSid = row.querySelector('input[name^="student_id_"]');
                if (!hiddenSid) return;
                const sid = hiddenSid.value;
                fetch(`/api/v1/students/${sid}/permission_defaults`, { headers: { 'X-CSRFToken': window.CSRF_TOKEN || '' } })
                    .then(res => res.json())
                    .then(data => {
                        if (!data || !data.success || !data.data) return;
                        const dest = row.querySelector(`input[name="destination_${sid}"]`);
                        const trsp = row.querySelector(`input[name="transport_mode_${sid}"]`);
                        const reas = row.querySelector(`input[name="reason_${sid}"]`);
                        if (dest && !dest.value) dest.value = data.data.destination || '';
                        if (trsp && !trsp.value) trsp.value = data.data.transport_mode || '';
                        if (reas && !reas.value) reas.value = data.data.reason || '';
                    })
                    .catch(() => {});
            });
        })();

        // Helper to format a Date as YYYY-MM-DDTHH:MM (for input[type="datetime-local"])
        const formatLocal = (d) => {
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        if (fillAllButton) {
            fillAllButton.addEventListener('click', function() {
                const commonStartVal = (document.getElementById('common_start_datetime').value || '').trim();
                let commonEndVal = (document.getElementById('common_end_datetime').value || '').trim();

                // Optional duration: if provided and end is empty, compute end = start + duration
                const durInput = document.getElementById('common_duration_hours');
                const durRaw = durInput ? durInput.value : '';
                const durHours = durRaw !== '' ? parseFloat(durRaw) : NaN;

                if (!commonEndVal && commonStartVal && !Number.isNaN(durHours) && durHours > 0) {
                    const base = new Date(commonStartVal);
                    // Add duration in minutes (support fractions like 1.5 hours)
                    base.setMinutes(base.getMinutes() + Math.round(durHours * 60));
                    commonEndVal = formatLocal(base);
                    const endEl = document.getElementById('common_end_datetime');
                    if (endEl) endEl.value = commonEndVal; // reflect computed end back into common field
                }

                const commonDest = (document.getElementById('common_destination').value || '');
                const commonTransport = (document.getElementById('common_transport_mode').value || '');
                const commonPlutonRaw = (document.getElementById('common_pluton')?.value || '').trim();
                let commonPluton = commonPlutonRaw;
                const m = commonPlutonRaw.toUpperCase().match(/^ALL\s+(.*)$/);
                if (m) { commonPluton = m[1].trim(); }

                // Fill destination/transport only if provided
                if (commonDest) {
                    document.querySelectorAll('.common-dest').forEach(input => input.value = commonDest);
                }
                if (commonTransport) {
                    document.querySelectorAll('.common-transport').forEach(input => input.value = commonTransport);
                }
                if (commonPluton) {
                    document.querySelectorAll('.common-pluton').forEach(input => input.value = commonPluton);
                }

                // Fill start/end values
                if (commonStartVal) {
                    document.querySelectorAll('.common-start').forEach(input => input.value = commonStartVal);
                }
                if (commonEndVal) {
                    document.querySelectorAll('.common-end').forEach(input => input.value = commonEndVal);
                }

                // If both start and end exist and end <= start, auto-adjust end to next day keeping the time-of-day
                if (commonStartVal && commonEndVal) {
                    document.querySelectorAll('tbody tr').forEach(row => {
                        const s = row.querySelector('.common-start');
                        const e = row.querySelector('.common-end');
                        if (!s || !e || !s.value || !e.value) return;

                        const sDate = new Date(s.value);
                        const eDate = new Date(e.value);

                        if (eDate <= sDate) {
                            // Keep end time-of-day, but move to next day relative to start
                            const endHours = eDate.getHours();
                            const endMinutes = eDate.getMinutes();
                            const adjusted = new Date(sDate);
                            adjusted.setDate(adjusted.getDate() + 1);
                            adjusted.setHours(endHours, endMinutes, 0, 0);
                            e.value = formatLocal(adjusted);
                        }
                    });
                }
            });
        }

        permissionDetailsForm.addEventListener('submit', function(event) {
            let isValid = true;
            const rows = permissionDetailsForm.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const startInput = row.querySelector('input[name^="start_datetime_"]');
                const endInput = row.querySelector('input[name^="end_datetime_"]');
                if (!startInput.value || !endInput.value) {
                    isValid = false;
                }
                if (new Date(endInput.value) <= new Date(startInput.value)) {
                    isValid = false;
                    startInput.classList.add('is-invalid');
                    endInput.classList.add('is-invalid');
                } else {
                    startInput.classList.remove('is-invalid');
                    endInput.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                alert('Verificați datele introduse. Fiecare permisie trebuie să aibă o dată de început și de sfârșit, iar data de sfârșit trebuie să fie după cea de început.');
                event.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
