{% extends "base.html" %}

{% block title %}Gestionează Situațiile Salvate{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0"><i class="fas fa-history me-2"></i> Gestionează Situațiile Salvate (Snapshots)</h2>
  <a href="{{ url_for('list_situations') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-2"></i> Înapoi la Formulare
  </a>
</div>

<p class="text-muted">Aici poți vizualiza, șterge sau restaura o situație salvată. Restaurarea unei situații va suprascrie toate datele curente (permisii, învoiri, servicii) pentru studenții tăi cu cele din copia salvată. Această acțiune nu poate fi anulată.</p>

<div class="card shadow-sm">
  <div class="list-group list-group-flush">
    {% if snapshots %}
      {% for s in snapshots %}
      <div class="list-group-item">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{ s.name }}</h5>
          <small class="text-muted">Salvat la: {{ s.created_at | localdatetime }}</small>
        </div>
        <p class="mb-1">
            <span class="badge bg-primary">Permisii: {{ s.data_summary.permissions }}</span>
            <span class="badge bg-success">Învoiri Zilnice: {{ s.data_summary.daily_leaves }}</span>
            <span class="badge bg-info">Învoiri Weekend: {{ s.data_summary.weekend_leaves }}</span>
            <span class="badge bg-warning text-dark">Servicii: {{ s.data_summary.service_assignments }}</span>
        </p>
        <div class="mt-2">
            <a href="{{ url_for('view_situation_snapshot', snapshot_id=s.id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye me-1"></i> Vizualizează</a>

            <button class="btn btn-sm btn-outline-info copy-link-btn" data-link="{{ url_for('public_snapshot_view', snapshot_id=s.id, _external=True) }}">
                <i class="fas fa-link me-1"></i> Copiază Link Public
            </button>

            <form action="{{ url_for('reset_situation_snapshot', snapshot_id=s.id) }}" method="POST" onsubmit="return confirm('ATENȚIE! Ești sigur că vrei să restaurezi această situație? Toate învoirile și permisiile curente vor fi ȘTERSE și înlocuite cu cele din această copie. Acțiunea este ireversibilă.');" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-undo me-1"></i> Restaurează</button>
            </form>

            <form action="{{ url_for('delete_situation_snapshot', snapshot_id=s.id) }}" method="POST" onsubmit="return confirm('Ești sigur că vrei să ștergi această situație salvată? Acțiunea este ireversibilă.');" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash me-1"></i> Șterge</button>
            </form>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="list-group-item">
        <div class="alert alert-info mb-0">Nu ai nicio situație salvată.</div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-link-btn').forEach(button => {
        button.addEventListener('click', function() {
            const link = this.dataset.link;
            navigator.clipboard.writeText(link).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check me-1"></i> Copiat!';
                this.classList.remove('btn-outline-info');
                this.classList.add('btn-success');
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-info');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Nu s-a putut copia link-ul.');
            });
        });
    });
});
</script>
{% endblock %}
