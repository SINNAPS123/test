{% extends "base.html" %}

{% block title %}Calendar Evenimente{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h2 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i> Calendar Evenimente
        </h2>
        <div class="d-flex flex-wrap gap-2">
            <button id="copyCalendarLinkBtn" class="btn btn-outline-primary">
                <i class="fas fa-link me-2"></i>Generează/Copiază link calendar
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Înapoi la Panou
            </a>
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS from CDN -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        initialView: 'dayGridMonth',
        height: 'auto',
        expandRows: true,
        stickyHeaderDates: true,
        dayMaxEventRows: 3,
        nowIndicator: true,
        locale: 'ro',
        buttonText: {
            today: 'Astăzi',
            month: 'Lună',
            week: 'Săptămână',
            day: 'Zi',
            list: 'Listă'
        },
        events: '{{ events_url }}',
        eventClick: function(info) {
            // Dezactivăm complet click-urile pe evenimente (cerință)
            if (info.jsEvent) {
                info.jsEvent.preventDefault();
                info.jsEvent.stopPropagation();
            }
            return false;
        },
        eventDidMount: function(arg) {
            // Tooltip nativ cu numele și tipul pentru lizibilitate rapidă
            const student = (arg.event.extendedProps && arg.event.extendedProps.student) || '';
            const type = (arg.event.extendedProps && arg.event.extendedProps.type) || '';
            arg.el.setAttribute('title', (student ? student : arg.event.title) + (type ? ' — ' + type : ''));
        },
        eventContent: function(arg) {
            // Afișare compactă: Nume pe primul rând, tip pe al doilea
            const student = (arg.event.extendedProps && arg.event.extendedProps.student) || '';
            const type = (arg.event.extendedProps && arg.event.extendedProps.type) || '';
            const title = student || arg.event.title || '';
            const inner = document.createElement('div');
            inner.className = 'fc-event-custom';
            inner.innerHTML = `
                <div class="fw-semibold text-truncate">${title}</div>
                ${type ? `<div class="small text-truncate opacity-75">${type}</div>` : ''}
            `;
            return { domNodes: [inner] };
        },
        loading: function(isLoading) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.toggle('show', !!isLoading);
            }
        }
    });

    calendar.render();

    // Copiere/generare link calendar (în prima fază copiază link-ul paginii curente)
    const copyBtn = document.getElementById('copyCalendarLinkBtn');
    copyBtn?.addEventListener('click', async () => {
        try {
            const url = window.location.href;
            await navigator.clipboard.writeText(url);
            copyBtn.innerHTML = '<i class="fas fa-check me-2"></i>Link copiat';
            setTimeout(()=>copyBtn.innerHTML = '<i class="fas fa-link me-2"></i>Generează/Copiază link calendar', 1500);
        } catch (e) {
            alert('Nu s-a putut copia link-ul. ' + (e?.message || ''));
        }
    });
});
</script>
<style>
/* Îmbunătățiri de lizibilitate pentru evenimente, inclusiv pe tema întunecată */
.fc .fc-event, .fc .fc-event-main {
  line-height: 1.2;
}
.fc .fc-event-custom .fw-semibold { font-weight: 600; }
.fc .fc-daygrid-day-number { font-weight: 600; }
[data-theme="dark"] .fc .fc-daygrid-day-number { color: var(--text); }
[data-theme="dark"] .fc .fc-toolbar-title { color: var(--text); }
[data-theme="dark"] .fc .fc-button { color: var(--text); }
[data-theme="dark"] .fc .fc-daygrid-event, 
html.dark-mode-preload .fc .fc-daygrid-event {
  background-color: #0f172a !important;
  border-color: #334155 !important;
  color: #e6f0ff !important;
}
</style>
{% endblock %}
