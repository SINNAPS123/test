{% extends "base.html" %}

{% block title %}Listă Permisii - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Listă Permisii</h2>
        <div>
            <a href="{{ url_for('add_edit_permission') }}" class="btn btn-success me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-plus-fill" viewBox="0 0 16 16">
                    <path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4V.5zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2zM8.5 8.5V10H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V11H6a.5.5 0 0 1 0-1h1.5V8.5a.5.5 0 0 1 1 0z"/>
                </svg>
                Adaugă Permisie Nouă
            </a>
            <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#bulkImportPermissionsModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Import Permisii (Text)
            </button>
            <a href="{{ url_for('export_permissions_word') }}" class="btn btn-primary me-2">
                <i class="fas fa-file-word"></i> Export Word (Permisii)
            </a>
             <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">&laquo; Panou Gradat</a>
        </div>
    </div>

    {% macro render_permissions_table(permissions, table_title, table_id) %}
        {% if permissions %}
        <h4 class="mt-4">{{ table_title }} ({{ permissions|length }})</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead> <!-- Am eliminat clasa table-dark -->
                    <tr>
                        <th>Student</th>
                        <th>Grad</th>
                        <th>De la</th>
                        <th>Până la</th>
                        <th>Destinație</th>
                        <th>Transport</th>
                        <th>Motiv/Obs.</th>
                        <th>Status</th>
                        <th>Acțiuni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in permissions %}
                    <tr class="{{ 'table-success' if p.is_active else ('table-warning' if p.is_upcoming else 'table-secondary') }}">
                        <td>{{ p.student.nume }} {{ p.student.prenume }}</td>
                        <td>{{ p.student.grad_militar }}</td>
                        <td>{{ p.start_datetime.strftime('%d-%m-%Y %H:%M') }}</td>
                        <td>{{ p.end_datetime.strftime('%d-%m-%Y %H:%M') }}</td>
                        <td>{{ p.destination if p.destination else '-' }}</td>
                        <td>{{ p.transport_mode if p.transport_mode else '-' }}</td>
                        <td>{{ p.reason if p.reason else '-' }}</td>
                        <td>
                            {% if p.status == 'Aprobată' %}
                                {% if p.is_active %}
                                    <span class="badge bg-success">Activă</span>
                                {% elif p.is_upcoming %}
                                    <span class="badge bg-warning text-dark">Urmează</span>
                                {% else %}
                                    <span class="badge bg-secondary">Expirată</span>
                                {% endif %}
                            {% elif p.status == 'Anulată' %}
                                <span class="badge bg-danger">Anulată</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ p.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('add_edit_permission', permission_id=p.id) }}" class="btn btn-sm btn-warning me-1 py-0 px-1" title="Editare Permisie">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if p.status == 'Aprobată' and (p.is_active or p.is_upcoming) %}
                            <form method="POST" action="{{ url_for('cancel_permission', permission_id=p.id) }}" class="d-inline" onsubmit="return confirm('Ești sigur că vrei să anulezi această permisie?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1" title="Anulează Permisia">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </form>
                            {% elif p.status != 'Anulată' and p.is_past %}
                                <span class="text-muted fst-italic small">Expirată</span>
                            {% elif p.status == 'Anulată' %}
                                <span class="text-muted fst-italic small">Anulată</span>
                            {% endif %}
                            {# Buton de ștergere permanentă, vizibil mereu, dar poate condiționat de rol dacă e necesar #}
                            <form method="POST" action="{{ url_for('delete_permission', permission_id=p.id) }}" class="d-inline" onsubmit="return confirm('Ești sigur că vrei să ȘTERGI PERMANENT această permisie? Această acțiune nu poate fi anulată.');">
                                <button type="submit" class="btn btn-sm btn-danger py-0 px-1 ms-1" title="Șterge Permisia Permanent">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {# Am eliminat clauza else pentru a gestiona mesajul global #}
        {% endif %}
    {% endmacro %}

    {% if active_permissions or upcoming_permissions or past_permissions %}
        {{ render_permissions_table(active_permissions, 'Permisii Active Acum', 'active-permissions') }}
        {{ render_permissions_table(upcoming_permissions, 'Permisii Viitoare', 'upcoming-permissions') }}
        {{ render_permissions_table(past_permissions, 'Permisii Trecute/Anulate', 'past-permissions') }}
    {% else %}
        <div class="alert alert-info mt-4" role="alert">
            Nu există permisii de afișat. Puteți adăuga o <a href="{{ url_for('add_edit_permission') }}" class="alert-link">permisie nouă aici</a>.
        </div>
    {% endif %}

    <p class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
            &laquo; Înapoi la Panoul Gradat
        </a>
    </p>
</div>

<!-- Modal pentru Bulk Import Permisii -->
<div class="modal fade" id="bulkImportPermissionsModal" tabindex="-1" aria-labelledby="bulkImportPermissionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('bulk_import_permissions') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkImportPermissionsModalLabel">Import Permisii în Masă</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Introduceți datele permisiilor, fiecare permisie pe rânduri consecutive, în formatul:</p>
                    <pre><code>Grad Nume Prenume
Data_inceput Ora_inceput - Data_sfarsit Ora_sfarsit
Destinatie
Numar_masina (opțional, lăsați rând gol dacă nu există)</code></pre>
                    <p><strong>Exemplu:</strong></p>
                    <pre><code>M.m.IV Renț Francisc
04.07.2024 15:00 - 06.07.2024 22:00
Slobozia, Argeș
AG 03 RXF

Sdt. Marinescu Ioana
10.07.2024 08:00 - 10.07.2024 18:00
București
</code></pre>
                    <p>Asigurați-vă că există un rând gol între fiecare permisie dacă nu se specifică numărul de mașină, sau la finalul listei dacă ultima permisie nu are număr de mașină.</p>
                    <p>Format datetimes: <code>DD.MM.YYYY HH:MM</code></p>
                    <div class="mb-3">
                        <label for="permission_bulk_data" class="form-label">Date Permisii:</label>
                        <textarea class="form-control" id="permission_bulk_data" name="permission_bulk_data" rows="12" required placeholder="M.m.IV Renț Francisc\n04.07.2024 15:00 - 06.07.2024 22:00\nSlobozia, Argeș\nAG 03 RXF\n\nSdt. Popescu Vasile\n05.08.2024 10:00 - 05.08.2024 19:00\nCraiova\n"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <button type="submit" class="btn btn-primary">Importă Permisii</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
