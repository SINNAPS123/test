{% extends "base.html" %}


{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Panou de Control Admin</h2>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Creare Utilizator Nou (Gradat/Comandant)</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_create_user') }}">
                        <div class="mb-3">
                            <label for="username" class="form-label">Nume utilizator:</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                            <small class="form-text text-muted">
                                Ex: <strong>Popescu_V</strong> (gradat),
                                <strong>CmdC1</strong> (Cmd. Compania 1),
                                <strong>CmdB1</strong> (Cmd. Batalionul 1).
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Rol:</label>
                            <select class="form-select" id="role" name="role" required>
                                <option value="" disabled selected>Selectează rolul</option>
                                <option value="gradat">Gradat (Comandant Pluton)</option>
                                <option value="comandant_companie">Comandant Companie</option>
                                <option value="comandant_batalion">Comandant Batalion</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Creare Utilizator și Generare Cod</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Informații Utile</h4>
                </div>
                <div class="card-body">
                    <p>Utilizatorii creați vor primi un <strong>cod unic</strong>. Ei trebuie să folosească acest cod la prima autentificare.</p>
                    <p>După prima autentificare cu codul unic, li se va cere să își seteze un <strong>cod personal</strong>.</p>
                    <p>Logările ulterioare se vor face folosind codul personal.</p>
                    <hr>
                    <h5>Statistici Sistem</h5>
                    <div class="row text-center g-2">
                        <div class="col-4">
                            <div class="stat-card p-2 border rounded shadow-sm">
                                <div class="h5 mb-0">{{ total_users }}</div>
                                <small class="text-muted">Utilizatori</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card p-2 border rounded shadow-sm">
                                <div class="h5 mb-0">{{ total_students }}</div>
                                <small class="text-muted">Studenți</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card p-2 border rounded shadow-sm">
                                <div class="h5 mb-0">{{ active_public_codes|length }}</div>
                                <small class="text-muted">Coduri Publice Active</small>
                            </div>
                        </div>
                    </div>
                    <!-- Linkul către admin_manage_special_graded a fost eliminat -->
                </div>
            </div>
        </div>
    </div>

    <!-- Adăugat înainte de <hr class="my-4"> și "Listă Utilizatori" -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Funcționalități Administrative Suplimentare</h4>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('admin_change_self_password') }}" class="btn btn-warning me-2 mb-2">
                        <i class="fas fa-key icon-rotate-hover"></i> Schimbă Propria Parolă (Admin)
                    </a>
                    <a href="{{ url_for('admin_action_logs') }}" class="btn btn-info me-2 mb-2">
                        <i class="fas fa-history icon-spin-hover"></i> Jurnal Acțiuni Sistem
                    </a>
                    <a href="{{ url_for('admin_list_students') }}" class="btn btn-secondary me-2 mb-2">
                        <i class="fas fa-users icon-rotate-hover"></i> Listă Generală Studenți
                    </a>
                    <a href="{{ url_for('admin_list_permissions') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-calendar-check icon-rotate-hover"></i> Listă Generală Permisii
                    </a>
                    <a href="{{ url_for('admin_list_daily_leaves') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-person-walking-arrow-right icon-rotate-hover"></i> Listă Generală Învoiri Zilnice
                    </a>
                     <a href="{{ url_for('admin_list_weekend_leaves') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-calendar-week icon-rotate-hover"></i> Listă Generală Învoiri Weekend
                    </a>
                    <a href="{{ url_for('admin_list_services') }}" class="btn btn-secondary me-2 mb-2">
                        <i class="fas fa-clipboard-user icon-rotate-hover"></i> Listă Generală Servicii
                    </a>
                    <a href="{{ url_for('admin_list_updates') }}" class="btn btn-primary me-2 mb-2">
                        <i class="fas fa-bullhorn icon-rotate-hover"></i> Management Anunțuri
                    </a>
                    <a href="{{ url_for('admin_homepage_settings') }}" class="btn btn-info me-2 mb-2">
                        <i class="fas fa-cog icon-spin-hover"></i> Setări Pagină Principală
                    </a>
                    <a href="{{ url_for('admin_maintenance') }}" class="btn btn-danger me-2 mb-2">
                        <i class="fas fa-tools icon-rotate-hover"></i> Mod Mentenanță
                    </a>

                    <hr class="my-3">
                    <h6 class="text-muted">Rapoarte Generale Word:</h6>
                    <a href="{{ url_for('admin_export_permissions_word') }}" class="btn btn-sm btn-outline-primary mb-2" title="Exportă toate permisiile active/viitoare din sistem">
                        <i class="fas fa-file-word icon-rotate-hover"></i> Export Permisii (Toate)
                    </a>
                    <a href="{{ url_for('admin_export_weekend_leaves_word') }}" class="btn btn-sm btn-outline-primary mb-2" title="Exportă toate învoirile de weekend active/viitoare din sistem">
                        <i class="fas fa-file-word icon-rotate-hover"></i> Export Învoiri Weekend (Toate)
                    </a>
                    <!-- Alte link-uri admin pot fi adăugate aici -->

                    <hr class="my-3">
                    <h6 class="text-muted">Exporturi Generale (Text):</h6>

                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <!-- Secțiunea de generare cod public -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Acces Public (Doar Vizualizare)</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Generează Cod Nou</h5>
                    <p class="small text-muted">Generează un cod unic pentru a oferi acces de vizualizare la situația unei companii sau a unui batalion.</p>
                    <form method="POST" action="{{ url_for('generate_public_view_code') }}">
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label for="scope_type" class="form-label">Tip Unitate:</label>
                                <select class="form-select" id="scope_type" name="scope_type" required>
                                    <option value="company" selected>Companie</option>
                                    <option value="battalion">Batalion</option>
                                    <option value="platoon">Pluton</option>
                                </select>
                            </div>
                            <div class="col-sm-6 mb-3" id="scope_id_wrap">
                                <label for="scope_id" class="form-label">ID Unitate:</label>
                                <input type="text" class="form-control" id="scope_id" name="scope_id" placeholder="Ex: 1, 12" required>
                            </div>
                        </div>
                        <div class="row g-2" id="platoon_fields" style="display:none;">
                            <div class="col-sm-6">
                                <label for="company_id_pl" class="form-label">Companie</label>
                                <input type="text" class="form-control" id="company_id_pl" placeholder="Ex: 1">
                            </div>
                            <div class="col-sm-6">
                                <label for="platoon_id_pl" class="form-label">Pluton</label>
                                <input type="text" class="form-control" id="platoon_id_pl" placeholder="Ex: 3">
                            </div>
                            <div class="col-12">
                                <small class="text-muted">Pentru Pluton, introduceți Companie și Pluton. La trimitere, se va genera intern scope_id de forma Companie:Pluton.</small>
                            </div>
                        </div>
                        <div class="mb-3 mt-2">
                            <label for="expiry_hours" class="form-label">Valabilitate Cod (în ore):</label>
                            <input type="number" class="form-control" id="expiry_hours" name="expiry_hours" value="24" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" onclick="syncPlatoonFieldsIntoScopeId(event)">
                            <i class="fas fa-cogs me-1"></i> Generează Cod
                        </button>
                    </form>
                </div>
                <div class="col-md-6">
                    <h5>Coduri Active</h5>
                     <div class="list-group" style="max-height: 250px; overflow-y: auto;">
                        {% if active_public_codes %}
                            {% for code in active_public_codes %}
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="font-monospace">{{ code.code }}</strong>
                                    <small class="d-block text-muted">
                                        Pentru: <strong>{{ code.scope_type|capitalize }} {{ code.scope_id }}</strong>
                                    </small>
                                    <small class="d-block text-muted">
                                        Expiră la: {{ code.expires_at|localdatetime }}
                                    </small>
                                    <small class="d-block text-muted">
                                        Creat de: {{ code.creator.username if code.creator else 'N/A' }}
                                    </small>
                                </div>
                                <form method="POST" action="{{ url_for('deactivate_public_view_code', code_id=code.id) }}" onsubmit="return confirm('Sunteți sigur că doriți să dezactivați acest cod?');">
                                    <button type="submit" class="btn btn-sm btn-outline-warning">Dezactivează</button>
                                </form>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted p-2">Nu există coduri active.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Management Date</h5>
                    <p class="small text-muted">Exportul sau importul complet al bazei de date. Utilizați cu precauție.</p>
                    <a href="{{ url_for('admin_data_management') }}" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-database me-1"></i> Import / Export
                    </a>
                </div>
            </div>
        </div>
    </div>
    <script>
    (function(){
        const scopeSel = document.getElementById('scope_type');
        const platoonWrap = document.getElementById('platoon_fields');
        const scopeIdWrap = document.getElementById('scope_id_wrap');
        function refresh(){
            if (!scopeSel) return;
            if (scopeSel.value === 'platoon'){
                platoonWrap.style.display = '';
                scopeIdWrap.querySelector('label').innerText = 'ID Unitate (opțional)';
                scopeIdWrap.querySelector('input').required = false;
            } else {
                platoonWrap.style.display = 'none';
                scopeIdWrap.querySelector('label').innerText = 'ID Unitate:';
                scopeIdWrap.querySelector('input').required = true;
            }
        }
        if (scopeSel){
            scopeSel.addEventListener('change', refresh);
            refresh();
        }
    })();
    function syncPlatoonFieldsIntoScopeId(e){
        const scopeSel = document.getElementById('scope_type');
        if (scopeSel && scopeSel.value === 'platoon'){
            const comp = document.getElementById('company_id_pl')?.value.trim();
            const pl = document.getElementById('platoon_id_pl')?.value.trim();
            if (!comp || !pl){
                alert('Introduceți Companie și Pluton pentru generarea codului de vizualizare pe pluton.');
                e.preventDefault();
                return false;
            }
            const scopeIdInput = document.getElementById('scope_id');
            if (scopeIdInput) scopeIdInput.value = comp + ':' + pl;
        }
        return true;
    }
    </script>

    <h3 class="mb-3">Listă Utilizatori (Non-Admin)</h3>
    {% if users %}
    <div class="table-responsive shadow-sm"> <!-- Added shadow-sm -->
        <table class="table table-striped table-hover table-sm"> <!-- Added table-sm -->
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume Utilizator</th>
                    <th>Rol</th>
                    <th>Cod Unic (la creare/reset)</th>
                    <th>Necesită Setare Cod Personal?</th>
                    <th>Acțiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                        {% if user.unique_code %}
                            <span class="badge bg-info text-dark">{{ user.unique_code }}</span>
                        {% else %}
                            <span class="badge bg-secondary">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_first_login %}
                            <span class="badge bg-warning text-dark">Da</span>
                        {% else %}
                            <span class="badge bg-success">Nu (Cod personal setat)</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.role != 'admin' %}
                        <div class="btn-group btn-group-sm" role="group" aria-label="User Actions for {{ user.username }}">
                            <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="btn btn-primary" title="Modifică numele de utilizator">
                                <i class="fas fa-edit icon-rotate-hover me-1"></i>Editare User
                            </a>
                            <a href="{{ url_for('admin_set_user_personal_code', user_id=user.id) }}" class="btn btn-info" title="Setează un nou cod personal direct pentru utilizator">
                                <i class="fas fa-shield-alt icon-rotate-hover me-1"></i>Setare Cod Personal
                            </a>
                            <form method="POST" action="{{ url_for('admin_reset_user_code', user_id=user.id) }}" class="d-inline" onsubmit="return confirm('Ești sigur că vrei să resetezi codul pentru {{ user.username }}? Acest lucru va genera un nou cod unic și va necesita ca utilizatorul să își seteze un nou cod personal la următoarea logare.');">
                                <button type="submit" class="btn btn-warning" title="Generează un nou cod unic și forțează utilizatorul să seteze un nou cod personal la următoarea logare">
                                    <i class="fas fa-key icon-rotate-hover me-1"></i>Resetare Cod Unic
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" class="d-inline" onsubmit="return confirm('ATENȚIE! Ești sigur că vrei să ștergi utilizatorul {{ user.username }}? Dacă este gradat, TOȚI studenții și datele asociate acestuia (permisii, învoiri, servicii, etc.) vor fi ȘTERSE DEFINITIV. Această acțiune este ireversibilă!');">
                                <button type="submit" class="btn btn-danger" title="Șterge utilizatorul și toate datele asociate">
                                    <i class="fas fa-trash-alt icon-rotate-hover me-1"></i>Șterge Utilizator
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Nu există alți utilizatori în sistem.</p>
    {% endif %}
</div>
{% endblock %}
