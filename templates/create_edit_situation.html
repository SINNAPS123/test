{% extends "base.html" %}

{% block title %}{{ situation and 'Editează Situație' or 'Creează Situație' }}{% endblock %}

{% block content %}
<h2 class="mb-3">
  <i class="fas fa-clipboard-list me-2"></i>
  {{ situation and 'Editează Situație' or 'Creează Situație' }}
</h2>

{% if situation and situation.public_code %}
  <div class="alert alert-info d-flex align-items-center justify-content-between">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span>Link public pentru completare:</span>
      {% set public_url = url_for('public_situation_submit', code=situation.public_code, _external=True) %}
      <code class="me-2">{{ public_url }}</code>
      <button type="button" class="btn btn-sm btn-outline-secondary" data-copy-text="{{ public_url }}">
        <i class="fas fa-copy me-1"></i> Copiază
      </button>
      {% if situation.public_expires_at %}<small class="text-muted">(expiră la {{ situation.public_expires_at|localdatetime }})</small>{% endif %}
    </div>
    <a href="{{ url_for('situation_entries', situation_id=situation.id) }}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-table me-1"></i> Răspunsuri
    </a>
  </div>
{% endif %}

<form method="POST" novalidate>
  <div class="mb-3">
    <label class="form-label">Titlu *</label>
    <input type="text" class="form-control" name="title" value="{{ form_data.title or '' }}" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Descriere</label>
    <textarea class="form-control" name="description" rows="2">{{ form_data.description or '' }}</textarea>
  </div>

  {% if situation %}
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if form_data.is_active %}checked{% endif %}>
    <label class="form-check-label" for="is_active">Activă</label>
  </div>
  {% endif %}

  <div class="mb-2">
    <label class="form-label">Structura Formularului (generată automat)</label>
    <textarea class="form-control" name="fields_schema" id="fields_schema" rows="10">{{ form_data.fields_schema or '' }}</textarea>
    <div class="form-text">
      Folosiți constructorul de mai jos pentru a adăuga și edita câmpuri. Câmpul de text de mai sus se va actualiza automat și nu necesită editare manuală.
    </div>
  </div>

  <!-- Builder vizual pentru câmpuri -->
  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span><i class="fas fa-wrench me-2"></i>Constructor Câmpuri Formular</span>
      <div class="d-none d-md-flex align-items-center gap-2 small text-muted">
        <i class="fas fa-mouse-pointer"></i> Dublu-clic pe un câmp pentru a-l edita.
      </div>
    </div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Etichetă Câmp</label>
          <input type="text" id="b_label" class="form-control" placeholder="Ex. Nume student">
        </div>
        <div class="col-md-3">
          <label class="form-label">Nume Tehnic (ID)</label>
          <input type="text" id="b_name" class="form-control" placeholder="ex: student_name">
          <div class="form-text">ID unic. Se generează automat din etichetă.</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tip Câmp</label>
          <select id="b_type" class="form-select">
            <option value="text">text</option>
            <option value="textarea">textarea</option>
            <option value="date">date</option>
            <option value="time">time</option>
            <option value="number">number</option>
            <option value="email">email</option>
            <option value="tel">tel</option>
            <option value="checkbox">checkbox</option>
            <option value="radio">radio</option>
            <option value="select">select</option>
            <option value="student_select">student_select</option>
          </select>
          <div class="form-text">
            Tipuri: text, textarea, date, time, number, email, tel, checkbox, radio/select, student_select (listă studenți).
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Obligatoriu</label>
          <select id="b_required" class="form-select">
            <option value="false">Nu</option>
            <option value="true">Da</option>
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Opțiuni (separate prin virgulă)</label>
          <input type="text" id="b_options" class="form-control" placeholder="ex: Opțiunea 1, Opțiunea 2">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Text Sugerare (Placeholder)</label>
          <input type="text" id="b_placeholder" class="form-control" placeholder="Apare în interiorul câmpului gol.">
        </div>
        <div class="col-12">
          <label class="form-label">Text Ajutător (sub câmp)</label>
          <input type="text" id="b_help" class="form-control" placeholder="Apare sub câmp ca o instrucțiune.">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Valoare Predefinită</label>
          <input type="text" id="b_default" class="form-control" placeholder="Pentru checkbox, folosiți 'true'.">
        </div>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2" id="form_actions">
        <button type="button" id="add_field_btn" class="btn btn-outline-primary"><i class="fas fa-plus me-1"></i>Adaugă Câmp Nou</button>
        <button type="button" id="update_field_btn" class="btn btn-primary d-none"><i class="fas fa-save me-1"></i>Salvează Modificările</button>
        <button type="button" id="cancel_edit_btn" class="btn btn-secondary d-none"><i class="fas fa-times me-1"></i>Anulează</button>
        <button type="button" id="clear_fields_btn" class="btn btn-outline-danger"><i class="fas fa-trash me-1"></i>Golește Toate Câmpurile</button>

        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-bolt me-1"></i> Șabloane rapide
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item quick-template" data-tpl="nume">Nume complet (text, obligatoriu)</a></li>
            <li><a class="dropdown-item quick-template" data-tpl="telefon">Telefon (tel)</a></li>
            <li><a class="dropdown-item quick-template" data-tpl="email">Email (email)</a></li>
            <li><a class="dropdown-item quick-template" data-tpl="data">Dată (date, obligatoriu)</a></li>
            <li><a class="dropdown-item quick-template" data-tpl="student">Select student (student_select)</a></li>
          </ul>
        </div>
      </div>

      <hr>
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Listă Câmpuri</h6>
        <small class="text-muted">Trageți pentru a reordona.</small>
      </div>
      <ul id="fields_list" class="list-group small mt-2"></ul>

      <hr>
      <h6>Previzualizare Formular</h6>
      <div id="form_preview" class="border rounded p-3 bg-light"></div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary" formnovalidate><i class="fas fa-save me-2"></i> Salvează</button>
    <a href="{{ url_for('list_situations') }}" class="btn btn-secondary">Înapoi</a>
  </div>
</form>

<script>
(function(){
  let currentlyEditingIndex = null;

  function slugify(str){
    return (str || '')
      .toString()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'_')
      .replace(/^_+|_+$/g,'')
      .substring(0,60);
  }

  function readSchema() {
    const ta = document.getElementById('fields_schema');
    try {
      const data = ta.value.trim() ? JSON.parse(ta.value) : [];
      return Array.isArray(data) ? data : [];
    } catch(e) { return []; }
  }
  function writeSchema(arr) {
    document.getElementById('fields_schema').value = JSON.stringify(arr, null, 2);
  }

  function moveItem(arr, from, to){
    if (to < 0 || to >= arr.length) return arr;
    const copy = arr.slice();
    const [item] = copy.splice(from,1);
    copy.splice(to,0,item);
    return copy;
  }

  function renderListItem(f, idx){
    const optionsBadge = (f.options && f.options.length) ? ' • opțiuni: ' + f.options.join('/') : '';
    const reqBadge = f.required ? ' • obligatoriu' : '';
    const extra = [];
    if (f.placeholder) extra.push(`ph: "${f.placeholder}"`);
    if (f.help) extra.push(`help`);
    if (f.default !== undefined && f.default !== '') extra.push(`default: "${f.default}"`);
    const extras = extra.length ? ' • ' + extra.join(', ') : '';

    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.setAttribute('draggable','true');
    li.dataset.index = String(idx);

    li.innerHTML = `
      <div class="me-2 flex-grow-1">
        <strong>${f.label || f.name}</strong> <code>(${f.name})</code> - ${f.type}${reqBadge}${optionsBadge}${extras}
      </div>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-secondary" data-act="up" title="Mută sus"><i class="fas fa-arrow-up"></i></button>
        <button type="button" class="btn btn-outline-secondary" data-act="down" title="Mută jos"><i class="fas fa-arrow-down"></i></button>
        <button type="button" class="btn btn-outline-primary" data-act="edit" title="Editează"><i class="fas fa-pen"></i></button>
        <button type="button" class="btn btn-outline-warning" data-act="dup" title="Duplică"><i class="fas fa-clone"></i></button>
        <button type="button" class="btn btn-outline-danger" data-act="del" title="Șterge"><i class="fas fa-times"></i></button>
      </div>
    `;

    li.addEventListener('dragstart', (e)=> {
      if (currentlyEditingIndex !== null) e.preventDefault();
      else {
        e.dataTransfer.setData('text/plain', String(idx));
        li.classList.add('opacity-50');
      }
    });
    li.addEventListener('dragend', ()=> li.classList.remove('opacity-50'));
    li.addEventListener('dragover', (e)=> e.preventDefault());
    li.addEventListener('drop', (e)=> {
      if (currentlyEditingIndex !== null) return;
      e.preventDefault();
      const from = parseInt(e.dataTransfer.getData('text/plain'),10);
      const to = idx;
      const arr = readSchema();
      const newArr = moveItem(arr, from, to);
      writeSchema(newArr);
      refreshList();
    });

    li.addEventListener('dblclick', ()=> openEditor(idx));

    li.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (currentlyEditingIndex !== null && btn.getAttribute('data-act') !== 'edit') return;
        const act = btn.getAttribute('data-act');
        const arr = readSchema();
        if (act === 'up'){
          writeSchema(moveItem(arr, idx, idx-1));
          refreshList();
        } else if (act === 'down'){
          writeSchema(moveItem(arr, idx, idx+1));
          refreshList();
        } else if (act === 'del'){
          arr.splice(idx,1); writeSchema(arr); refreshList();
        } else if (act === 'dup'){
          const clone = JSON.parse(JSON.stringify(arr[idx]));
          clone.name = slugify(clone.name + '_copy');
          arr.splice(idx+1,0,clone); writeSchema(arr); refreshList();
        } else if (act === 'edit'){
          openEditor(idx);
        }
      });
    });
    return li;
  }

  function renderPreview(){
    const container = document.getElementById('form_preview');
    const fields = readSchema();
    container.innerHTML = '';
    if (!fields.length){
      container.innerHTML = '<div class="text-muted small">Niciun câmp definit încă.</div>';
      return;
    }
    fields.forEach((f)=>{
      const wrap = document.createElement('div');
      wrap.className = 'mb-2';
      const label = document.createElement('label');
      label.className = 'form-label';
      label.textContent = f.label || f.name;
      if (f.required) label.innerHTML += ' <span class="text-danger">*</span>';
      wrap.appendChild(label);
      let inputEl = null;
      switch(f.type){
        case 'textarea': inputEl = document.createElement('textarea'); inputEl.className='form-control'; inputEl.rows=3; break;
        case 'select': case 'student_select': inputEl = document.createElement('select'); inputEl.className='form-select'; inputEl.innerHTML=`<option value="">${f.placeholder||'-- selectează --'}</option>`+(f.options||[]).map(o=>`<option value="${o}">${o}</option>`).join(''); break;
        case 'radio': inputEl = document.createElement('div'); inputEl.className='d-flex flex-wrap gap-3'; (f.options||[]).forEach((opt,i)=>{ const div=document.createElement('div'); div.className='form-check'; div.innerHTML=`<input type="radio" class="form-check-input" name="${f.name}" id="${f.name}_${i+1}" value="${o}" disabled><label class="form-check-label" for="${f.name}_${i+1}">${o}</label>`; inputEl.appendChild(div); }); break;
        case 'checkbox': inputEl = document.createElement('div'); inputEl.className='form-check'; inputEl.innerHTML=`<input type="checkbox" class="form-check-input" id="${f.name}" disabled><label class="form-check-label" for="${f.name}">${f.placeholder||'Bifează'}</label>`; break;
        default: inputEl = document.createElement('input'); inputEl.type = f.type || 'text'; inputEl.className = 'form-control';
      }
      if(inputEl.placeholder !== undefined) inputEl.placeholder = f.placeholder || '';
      if(f.default && inputEl.value !== undefined) inputEl.value = f.default;
      if (inputEl) { if (inputEl.tagName !== 'DIV') inputEl.disabled = true; wrap.appendChild(inputEl); }
      if (f.help){ const help = document.createElement('div'); help.className = 'form-text'; help.textContent = f.help; wrap.appendChild(help); }
      container.appendChild(wrap);
    });
  }

  function refreshList() {
    const ul = document.getElementById('fields_list');
    const arr = readSchema();
    ul.innerHTML = '';
    arr.forEach((f, idx) => ul.appendChild(renderListItem(f, idx)));
    renderPreview();
  }

  function getFieldFromInputs(){
    const label = document.getElementById('b_label').value.trim();
    const nameManual = document.getElementById('b_name').value.trim();
    const name = nameManual || slugify(label);
    if (!name) { alert('Eticheta (Label) sau Numele Tehnic (Name) este obligatoriu.'); return null; }
    const type = document.getElementById('b_type').value;
    const required = document.getElementById('b_required').value === 'true';
    const optionsRaw = document.getElementById('b_options').value.trim();
    const placeholder = document.getElementById('b_placeholder').value.trim();
    const help = document.getElementById('b_help').value.trim();
    const def = document.getElementById('b_default').value.trim();
    const field = { name, label: label || name, type, required };
    if (type === 'select' || type === 'radio') field.options = optionsRaw ? optionsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    if (placeholder) field.placeholder = placeholder;
    if (help) field.help = help;
    if (def) field.default = def;
    return field;
  }

  function setInputsFromField(f){
    document.getElementById('b_label').value = f.label || '';
    document.getElementById('b_name').value = f.name || '';
    document.getElementById('b_type').value = f.type || 'text';
    document.getElementById('b_required').value = f.required ? 'true' : 'false';
    document.getElementById('b_options').value = (f.options || []).join(', ');
    document.getElementById('b_placeholder').value = f.placeholder || '';
    document.getElementById('b_help').value = f.help || '';
    document.getElementById('b_default').value = (f.default !== undefined && f.default !== null) ? String(f.default) : '';
  }

  function clearBuilderInputs(){
    setInputsFromField({type:'text', required:false});
    document.getElementById('b_label').focus();
  }

  function setBuilderMode(mode, index = null) {
    currentlyEditingIndex = (mode === 'edit') ? index : null;
    document.getElementById('add_field_btn').classList.toggle('d-none', mode === 'edit');
    document.getElementById('update_field_btn').classList.toggle('d-none', mode !== 'edit');
    document.getElementById('cancel_edit_btn').classList.toggle('d-none', mode !== 'edit');
    // Vizual, blochează alte acțiuni în mod editare
    document.getElementById('form_actions').nextElementSibling.classList.toggle('pe-none', mode === 'edit');
    document.getElementById('form_actions').nextElementSibling.classList.toggle('opacity-50', mode === 'edit');
  }

  function openEditor(idx){
    if (currentlyEditingIndex !== null) return;
    const arr = readSchema();
    const f = arr[idx];
    setInputsFromField(f);
    document.getElementById('b_label').focus();
    setBuilderMode('edit', idx);
  }

  let nameWasTouched = false;
  document.getElementById('b_name').addEventListener('input', ()=> nameWasTouched = true);
  document.getElementById('b_label').addEventListener('input', (e)=>{ if (!nameWasTouched) document.getElementById('b_name').value = slugify(e.target.value); });

  function onAddClick(){
    if (currentlyEditingIndex !== null) return;
    const field = getFieldFromInputs();
    if (!field) return;
    const arr = readSchema();
    const existing = new Set(arr.map(x=>x.name));
    let base = field.name, i=1;
    while (existing.has(field.name)) field.name = `${base}_${i++}`;
    arr.push(field);
    writeSchema(arr);
    refreshList();
    clearBuilderInputs();
    nameWasTouched = false;
  }

  function onUpdateClick(){
    if (currentlyEditingIndex === null) return;
    const updated = getFieldFromInputs();
    if (!updated) return;
    const arr = readSchema();
    arr[currentlyEditingIndex] = updated;
    writeSchema(arr);
    refreshList();
    setBuilderMode('add');
    clearBuilderInputs();
    nameWasTouched = false;
  }

  function onCancelClick(){
    setBuilderMode('add');
    clearBuilderInputs();
    nameWasTouched = false;
  }

  document.getElementById('add_field_btn')?.addEventListener('click', onAddClick);
  document.getElementById('update_field_btn')?.addEventListener('click', onUpdateClick);
  document.getElementById('cancel_edit_btn')?.addEventListener('click', onCancelClick);
  document.getElementById('clear_fields_btn')?.addEventListener('click', function(){ if (confirm('Sigur ștergi toate câmpurile din schemă?')) { writeSchema([]); refreshList(); } });

  document.querySelectorAll('.quick-template').forEach(a=>{
    a.addEventListener('click', ()=>{
      const tpl = a.getAttribute('data-tpl');
      let field = null;
      if (tpl === 'nume') field = { label:'Nume complet', name:'nume_complet', type:'text', required:true, placeholder:'Ex: Popescu Ion' };
      else if (tpl === 'telefon') field = { label:'Telefon', name:'telefon', type:'tel', required:false, placeholder:'07xx xxx xxx' };
      else if (tpl === 'email') field = { label:'Email', name:'email', type:'email', required:false, placeholder:'nume@exemplu.ro' };
      else if (tpl === 'data') field = { label:'Data', name:'data', type:'date', required:true };
      else if (tpl === 'student') field = { label:'Student', name:'student_id', type:'student_select', required:true, placeholder:'-- selectează student --' };
      if (field){ const arr = readSchema(); arr.push(field); writeSchema(arr); refreshList(); }
    });
  });

  refreshList();

  document.querySelectorAll('[data-copy-text]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const txt = btn.getAttribute('data-copy-text') || '';
      try{
        await navigator.clipboard.writeText(txt);
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiat';
        setTimeout(()=>{ btn.innerHTML = '<i class="fas fa-copy me-1"></i> Copiază'; }, 1500);
      }catch(e){ alert('Nu s-a putut copia în clipboard.'); }
    });
  });

  document.querySelector('form')?.addEventListener('submit', function(e){
    const errors = [];
    const allowedTypes = new Set(['text','textarea','date','time','number','email','tel','checkbox','radio','select','student_select']);
    let schema = [];
    const raw = document.getElementById('fields_schema').value.trim();
    if (raw){ try{ const parsed = JSON.parse(raw); if (!Array.isArray(parsed)) errors.push('Schema trebuie să fie o listă (array) de obiecte.'); else schema = parsed; } catch(err){ errors.push('JSON invalid în schema câmpurilor.'); } }
    const names = new Set();
    schema.forEach((f, idx)=>{
      if (!f || typeof f !== 'object'){ errors.push(`Elementul #${idx+1} din schemă nu este un obiect valid.`); return; }
      if (!f.name || typeof f.name !== 'string'){ errors.push(`Câmpul #${idx+1}: proprietatea "name" este obligatorie.`); } else { const slug = String(f.name).trim(); if (!slug) errors.push(`Câmpul #${idx+1}: "name" nu poate fi gol.`); if (names.has(slug)) errors.push(`Numele de câmp "${slug}" este duplicat.`); names.add(slug); }
      if (!f.type || typeof f.type !== 'string' || !allowedTypes.has(f.type)){ errors.push(`Câmpul "${f.name || ('#'+(idx+1))}": tip invalid. Tipuri permise: ${Array.from(allowedTypes).join(', ')}`); }
      if ((f.type === 'select' || f.type === 'radio') && (!Array.isArray(f.options) || f.options.length === 0)){ errors.push(`Câmpul "${f.name || ('#'+(idx+1))}": pentru tipul ${f.type} trebuie definite "options".`); }
    });
    if (errors.length){ e.preventDefault(); e.stopPropagation(); alert('Verifică schema câmpurilor înainte de salvare:\n\n- ' + errors.join('\n- ')); return false; }
    return true;
  });

  // Drag & Drop robust cu SortableJS (fallback pentru dispozitive unde DnD nativ nu merge bine)
  // CDN lightweight
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js';
  s.async = true;
  s.onload = function(){
    try{
      const ul = document.getElementById('fields_list');
      if (!ul) return;
      new Sortable(ul, {
        animation: 150,
        handle: null,
        ghostClass: 'opacity-50',
        onEnd: function (evt) {
          if (currentlyEditingIndex !== null) return;
          const from = evt.oldIndex;
          const to = evt.newIndex;
          if (from === to || from == null || to == null) return;
          const arr = readSchema();
          const newArr = (function(a,f,t){ const c=a.slice(); const [it]=c.splice(f,1); c.splice(t,0,it); return c; })(arr, from, to);
          writeSchema(newArr);
          refreshList();
        }
      });
    }catch(e){ console.warn('Sortable init error', e); }
  };
  document.body.appendChild(s);

})();
</script>
{% endblock %}