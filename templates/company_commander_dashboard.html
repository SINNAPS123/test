{% extends "base.html" %}

{% block title %}Panou Comandant Companie {{ company_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Panou Comandant Compania {{ company_id }}</h2>
    <p class="text-muted">Situația efectivelor pentru Apelul de Seară din {{ roll_call_time_str }}</p>
    <hr>

    {% if presence_data %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Efective Compania {{ company_id }}</h4>
        </div>
        <div class="card-body">
            <p>
                <strong>Efectiv Control (EC):</strong> <span class="badge bg-dark fs-6">{{ presence_data.efectiv_control }}</span><br>
                <strong>Efectiv Prezent (Ep):</strong> <span class="badge bg-success fs-6">{{ presence_data.efectiv_prezent }}</span><br>
                <strong>Efectiv Absent (Ea):</strong> <span class="badge bg-danger fs-6">{{ presence_data.efectiv_absent_count }}</span>
            </p>
        </div>
    </div>

    {% if presence_data.absent_details_by_unit %}
        <h4 class="mt-4">Detalii Absenți pe Plutoane:</h4>
        {% for pluton_key, absent_list in presence_data.absent_details_by_unit.items()|sort %}
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <strong>{{ pluton_key }}</strong> (Absenți: {{ absent_list|length }})
                </div>
                <ul class="list-group list-group-flush">
                    {% if absent_list %}
                        {% for absent_student_detail in absent_list %}
                            <li class="list-group-item">{{ loop.index }}. {{ absent_student_detail }}</li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item text-success">Niciun absent în acest pluton.</li>
                    {% endif %}
                </ul>
            </div>
        {% endfor %}
    {% elif presence_data.efectiv_absent_count == 0 and presence_data.efectiv_control > 0 %}
        <div class="alert alert-success">
            <strong>Toți studenții din companie sunt prezenți!</strong>
        </div>
    {% elif presence_data.efectiv_control == 0 %}
        <div class="alert alert-info">
            Nu există studenți înregistrați pentru compania {{ company_id }}.
        </div>
    {% endif %}

    {% else %}
    <div class="alert alert-warning">Nu s-au putut încărca datele de prezență pentru companie.</div>
    {% endif %}

    <hr class="my-4">
    <h4 class="mt-4">Statistici Rapide (Compania {{ company_id }} - Acum)</h4>
    <div class="row">
        <div class="col-md-4">
            <div class="alert alert-info">
                Total Studenți în Permisie: <strong>{{ total_on_permission }}</strong>
            </div>
        </div>
        {# Aici se pot adăuga și alte statistici agregate pentru companie, ex: învoiri, servicii #}
        {# Pentru aceasta, ar trebui adusă logica de calcul din get_student_status și aplicată pe toți studenții companiei #}
        {# De exemplu:
           total_on_daily_leave = 0
           total_on_weekend_leave = 0
           total_on_service = 0
           all_students_in_company = Student.query.filter_by(companie=company_id_str).all()
           now_check = datetime.now()
           for stud in all_students_in_company:
               status = get_student_status(stud, now_check)
               if status.status_code == 'absent_daily_leave': total_on_daily_leave +=1
               elif status.status_code == 'absent_weekend_leave': total_on_weekend_leave +=1
               elif status.status_code == 'absent_service': total_on_service +=1
        #}
    </div>


    <p class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
            &laquo; Înapoi la Panoul Principal
        </a>
    </p>
</div>
{% endblock %}
