{% extends "base.html" %}

{% block title %}Vizualizare Publică - {{ access_info.scope_type|capitalize }} {{ access_info.scope_id }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .details-list {
        display: none;
        font-size: 0.85em;
        padding-left: 1.5rem;
    }
    .list-group-item-sm {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }
    .toggle-details-btn {
        font-size: 0.8em;
        padding: 0.1rem 0.4rem;
        margin-left: 10px;
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Situație Publică: <span class="text-info">{{ access_info.scope_type|capitalize }} {{ access_info.scope_id }}</span></h2>
            <p class="text-muted mb-0">Vizualizare în timp real la data: {{ get_localized_now()|localdatetime }}</p>
        </div>
        <a href="{{ url_for('public_view_logout') }}" class="btn btn-outline-danger">
            <i class="fas fa-sign-out-alt"></i> Deconectare
        </a>
    </div>
    <hr>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% elif report_data %}
        {% macro display_presence_details(data, id_prefix) %}
            {% set formation_details = data.get('in_formation_students_details', []) %}
            {% if formation_details %}
                <h6 class="mt-2 mb-1">
                    Prezenți în Formație ({{ data.get('in_formation_count', 0) }})
                    <button class="btn btn-outline-info btn-sm toggle-details-btn" data-bs-toggle="collapse" data-bs-target="#{{ id_prefix }}-formation-details">Detalii</button>
                </h6>
                <ul class="list-group list-group-flush collapse details-list" id="{{ id_prefix }}-formation-details">
                    {% for item in formation_details %}
                        <li class="list-group-item list-group-item-sm py-1">{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% set onduty_details = data.get('on_duty_students_details', []) %}
            {% if onduty_details %}
                <h6 class="mt-2 mb-1">
                    La Servicii ({{ data.get('on_duty_count', 0) }})
                    <button class="btn btn-outline-info btn-sm toggle-details-btn" data-bs-toggle="collapse" data-bs-target="#{{ id_prefix }}-onduty-details">Detalii</button>
                </h6>
                <ul class="list-group list-group-flush collapse details-list" id="{{ id_prefix }}-onduty-details">
                    {% for item in onduty_details %}
                        <li class="list-group-item list-group-item-sm py-1">{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% set graded_details = data.get('platoon_graded_duty_students_details', []) %}
            {% if graded_details %}
                <h6 class="mt-2 mb-1">
                    Gradați Pluton ({{ data.get('platoon_graded_duty_count', 0) }})
                    <button class="btn btn-outline-info btn-sm toggle-details-btn" data-bs-toggle="collapse" data-bs-target="#{{ id_prefix }}-platoon-graded-details">Detalii</button>
                </h6>
                <ul class="list-group list-group-flush collapse details-list" id="{{ id_prefix }}-platoon-graded-details">
                    {% for item in graded_details %}
                        <li class="list-group-item list-group-item-sm py-1">{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% set absent_details = data.get('absent_students_details', []) %}
            {% set smt_details = data.get('smt_students_details', []) %}
            {% set exempt_other_details = data.get('exempt_other_students_details', []) %}
            {% if absent_details or smt_details or exempt_other_details %}
                <h6 class="mt-2 mb-1">
                    Absenți Motivat ({{ data.get('efectiv_absent_total', 0) }})
                    <button class="btn btn-outline-info btn-sm toggle-details-btn" data-bs-toggle="collapse" data-bs-target="#{{ id_prefix }}-absent-details">Detalii</button>
                </h6>
                <ul class="list-group list-group-flush collapse details-list" id="{{ id_prefix }}-absent-details">
                    {% for item in absent_details %}
                        <li class="list-group-item list-group-item-sm py-1">{{ item }}</li>
                    {% endfor %}
                    {% for item in smt_details %}
                        <li class="list-group-item list-group-item-sm py-1 text-danger">{{ item }}</li>
                    {% endfor %}
                     {% for item in exempt_other_details %}
                        <li class="list-group-item list-group-item-sm py-1 text-warning">{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endmacro %}

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0">Situație Generală</h4>
            </div>
            <div class="card-body">
                <p>
                    <strong>Efectiv Control (EC):</strong> <span class="badge bg-dark fs-6">{{ report_data.get('efectiv_control', 0) }}</span><br>
                    <strong>Efectiv Prezent (Ep):</strong> <span class="badge bg-success fs-6">{{ report_data.get('efectiv_prezent_total', 0) }}</span>
                    <small class="d-block ms-3">(Din care: În formație: {{ report_data.get('in_formation_count', 0) }}, La servicii: {{ report_data.get('on_duty_count', 0) }}, Gradați Pluton: {{ report_data.get('platoon_graded_duty_count', 0) }})</small><br>
                    <strong>Efectiv Absent Motivat (Ea):</strong> <span class="badge bg-danger fs-6">{{ report_data.get('efectiv_absent_total', 0) }}</span>
                </p>
                {{ display_presence_details(report_data, "public-view") }}
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">Nu s-au putut încărca datele.</div>
    {% endif %}

</div>
{% endblock %}
